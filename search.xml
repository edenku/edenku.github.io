<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Git命令整理</title>
    <url>/2021/05/24/Git%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<h3 id="clone"><a href="#clone" class="headerlink" title="clone"></a>clone</h3><h4 id="下载指定tag项目"><a href="#下载指定tag项目" class="headerlink" title="下载指定tag项目"></a>下载指定tag项目</h4> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># git clone --branch [tags标签] [git地址]</span><br><span class="line">git clone --branch dubbo-2.5.4 https://gitee.com/apache/dubbo.git</span><br></pre></td></tr></table></figure>

<h3 id="push"><a href="#push" class="headerlink" title="push"></a>push</h3><h4 id="本地项目推送远程"><a href="#本地项目推送远程" class="headerlink" title="本地项目推送远程"></a>本地项目推送远程</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">1. git init 初始化本地项目</span><br><span class="line">PS D:\code\demo&gt; git init</span><br><span class="line">PS D:\code\demo&gt; git add .</span><br><span class="line">PS D:\code\demo&gt; git commit -m &#x27;init&#x27;</span><br><span class="line">2. 远程gitee/github创建空分支</span><br><span class="line">3. 本地关联远程分支</span><br><span class="line">PS D:\code\demo&gt; git remote add origin http://xx.xx.xx.xx:port/demo/demo.git</span><br><span class="line">4. 推送远程</span><br><span class="line">PS D:\code\demo&gt; git push -u origin master</span><br></pre></td></tr></table></figure>

<h3 id="reset"><a href="#reset" class="headerlink" title="reset"></a>reset</h3><h4 id="gitlab回滚代码"><a href="#gitlab回滚代码" class="headerlink" title="gitlab回滚代码"></a>gitlab回滚代码</h4><p>gitlab主master分支默认受保护，不允许任何人进行代码回滚，所以我们回滚需要先删除受保护标签。</p>
<p><img src="C:%5CUsers%5Cci22578%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210629104157190.png" alt="image-20210629104157190"></p>
<p>project-setting 去设置</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210629104419193.png" alt="image-20210629104419193"></p>
<p>点击不再保护按钮。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210629104530667.png" alt="image-20210629104530667"></p>
<p>接下来，我们就可以回滚到我们指定的代码提交记录了。</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">git reset -<span class="literal">-hard</span> &lt;commit<span class="literal">-id</span>&gt;</span><br><span class="line">git push <span class="operator">-f</span>   <span class="comment">## 强制推送</span></span><br><span class="line"><span class="comment">## 输入用户密码即可</span></span><br></pre></td></tr></table></figure>

<p>操作完以后最好还是把这个保护再添加回来。</p>
<h3 id="tag"><a href="#tag" class="headerlink" title="tag"></a>tag</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 打标签</span><br><span class="line">git tag -a V1.0 -m &#x27;V1.0的描述&#x27;</span><br><span class="line"># 删除标签</span><br><span class="line">git tag -d V1.0</span><br><span class="line"># 推送远程</span><br><span class="line">git push origin V1.0</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>常用命令</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>IDEA常用小技巧</title>
    <url>/2021/05/11/IDEA%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<h3 id="如何添加RunDashBoard"><a href="#如何添加RunDashBoard" class="headerlink" title="如何添加RunDashBoard"></a>如何添加RunDashBoard</h3><p>  view &gt; Tool Windows &gt; Run Dashboard 打开，如果没有找到，则需要在workspace.xml中添加如下代码。</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;component name=&quot;RunDashboard&quot;&gt;</span><br><span class="line">  &lt;option name=&quot;configurationTypes&quot;&gt;</span><br><span class="line">    &lt;set&gt;</span><br><span class="line">      &lt;option value=&quot;SpringBootApplicationConfigurationType&quot;/&gt;</span><br><span class="line">    &lt;/set&gt;</span><br><span class="line">  &lt;/option&gt;</span><br><span class="line">  &lt;option name=&quot;ruleStates&quot;&gt;</span><br><span class="line">    &lt;list&gt;</span><br><span class="line">      &lt;RuleState&gt;</span><br><span class="line">        &lt;option name=&quot;name&quot; value=&quot;ConfigurationTypeDashboardGroupingRule&quot;/&gt;</span><br><span class="line">      &lt;/RuleState&gt;</span><br><span class="line">      &lt;RuleState&gt;</span><br><span class="line">        &lt;option name=&quot;name&quot; value=&quot;StatusDashboardGroupingRule&quot;/&gt;</span><br><span class="line">      &lt;/RuleState&gt;</span><br><span class="line">    &lt;/list&gt;</span><br><span class="line">  &lt;/option&gt;</span><br><span class="line">&lt;/component&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Pom文件出现删除线"><a href="#Pom文件出现删除线" class="headerlink" title="Pom文件出现删除线"></a>Pom文件出现删除线</h3><p>正常的pom文件是不会有删除线的，我们的变成这样子了。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210604094212517.png" alt="image-20210604094212517"></p>
<p>怎么处理呢，file -&gt; setting -&gt; maven -&gt; ignored Files 将被忽略的pom文件取消选中。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210604094413930.png" alt="image-20210604094413930"></p>
]]></content>
      <tags>
        <tag>idea</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux安装教程之JDK的安装</title>
    <url>/2021/05/25/Linux%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B%E4%B9%8BJDK%E7%9A%84%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<h3 id="下载安装包"><a href="#下载安装包" class="headerlink" title="下载安装包"></a>下载安装包</h3><p>[<a href="https://repo.huaweicloud.com/java/jdk/">华为JDK镜像地址</a>]</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@ecs-a7d9 home]# wget https://repo.huaweicloud.com/java/jdk/8u192-b12/jdk-8u192-linux-x64.tar.gz</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210525151931568.png" alt="image-20210525151931568"></p>
<span id="more"></span>

<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>安装包移动至/usr/local 目录。</p>
<p>解压并创建软连接。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@ecs-a7d9 local]# mv jdk-8u192-linux-x64.tar.gz /usr/local/</span><br><span class="line">[root@ecs-a7d9 local]# cd /usr/local/</span><br><span class="line">[root@ecs-a7d9 local]# tar zxvf jdk-8u192-linux-x64.tar.gz </span><br><span class="line">[root@ecs-a7d9 local]# ln -s /usr/local/jdk1.8.0_192/ /usr/local/jdk8</span><br></pre></td></tr></table></figure>

<h3 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h3><p>修改 /etc目录下的profile文件，在末尾追加：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export JAVA_HOME=/usr/local/jdk8</span><br><span class="line">export JRE_HOME=$&#123;JAVA_HOME&#125;/jre</span><br><span class="line">export CLASSPATH=.:$&#123;JAVA_HOME&#125;/lib/dt.JAVA_HOME/lib/tools.jar:$&#123;JRE_HOME&#125;/lib</span><br><span class="line">export PATH=$&#123;JAVA_HOME&#125;/bin:$&#123;PATH&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210525152756788.png" alt="image-20210525152756788"></p>
<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@ecs-a7d9 local]# java -version</span><br><span class="line">-bash: java: command not found</span><br><span class="line">## 使环境变量立即生效</span><br><span class="line">[root@ecs-a7d9 local]# source /etc/profile</span><br><span class="line">[root@ecs-a7d9 local]# java -version</span><br><span class="line">java version &quot;1.8.0_192&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_192-b12)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.192-b12, mixed mode)</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210525152910866.png" alt="image-20210525152910866"></p>
]]></content>
      <categories>
        <category>软件安装</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux安装教程之Jekins的安装</title>
    <url>/2021/07/02/Linux%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B%E4%B9%8BJekins%E7%9A%84%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 当前操作系统版本</span><br><span class="line">[root@localhost ~]# cat /etc/redhat-release</span><br><span class="line">CentOS Linux release 7.4.1708 (Core) </span><br><span class="line"># 查看JDK版本</span><br><span class="line">[root@localhost ~]# java -version</span><br><span class="line">java version &quot;1.8.0_181&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_181-b13)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.181-b13, mixed mode)</span><br><span class="line"># 查看JDK安装目录</span><br><span class="line">[root@localhost ~]# echo $JAVA_HOME$</span><br><span class="line">/usr/local/jdk1.8.0_181$</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果没有安装JDK 请先安装JDK</p>
</blockquote>
<span id="more"></span>

<h2 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h2><h3 id="安装-Java"><a href="#安装-Java" class="headerlink" title="安装 Java"></a>安装 Java</h3><blockquote>
<p>如已安装，请跳过此节</p>
</blockquote>
<ul>
<li><p>下载安装包，我选择的JDK8<a href="https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html">官网地址</a></p>
</li>
<li><p>上传到服务器<code>/usr/local</code>目录。</p>
</li>
<li><p>解压并创建软连接。</p>
</li>
</ul>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost local]# tar zxvf jdk-8u181-linux-x64.tar.gz </span><br><span class="line">[root@localhost local]# ln -s /usr/local/jdk1.8.0_181/ /usr/local/jdk8</span><br></pre></td></tr></table></figure>

<ul>
<li>设置环境变量 <code>vi /etc/profile</code></li>
</ul>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export JAVA_HOME=/usr/local/jdk8</span><br><span class="line">export JRE_HOME=$&#123;JAVA_HOME&#125;/jre</span><br><span class="line">export CLASSPATH=.:$&#123;JAVA_HOME&#125;/lib/dt.JAVA_HOME/lib/tools.jar:$&#123;JRE_HOME&#125;/lib</span><br><span class="line">export PATH=$&#123;JAVA_HOME&#125;/bin:$&#123;PATH&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>source /etc/profile</code> 使环境变量立即生效</p>
</li>
<li><p><code>java -version</code> 验证</p>
</li>
</ul>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost local]# source /etc/profile</span><br><span class="line">[root@localhost local]# java -version</span><br><span class="line">java version &quot;1.8.0_181&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_181-b13)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.181-b13, mixed mode)</span><br></pre></td></tr></table></figure>

<h3 id="安装-Git"><a href="#安装-Git" class="headerlink" title="安装 Git"></a>安装 Git</h3><ul>
<li>安装编译源码的工具</li>
</ul>
<p>  <code>yum -y groupinstall &quot;Development Tools&quot;</code></p>
<ul>
<li>下载依赖包</li>
</ul>
<p>  <code>yum -y install zlib-devel perl-ExtUtils-MakeMaker asciidoc xmlto openssl-devel</code></p>
<ul>
<li>下载git 源码 并解压</li>
</ul>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# wget https://github.com/git/git/archive/v2.19.0.tar.gz</span><br><span class="line">[root@localhost ~]# mv v2.19.0.tar.gz /usr/local/</span><br><span class="line">[root@localhost ~]# tar -zxvf v2.19.0.tar.gz</span><br></pre></td></tr></table></figure>

<p>  <code>wget https://github.com/git/git/archive/v2.19.0.tar.gz</code></p>
<p>  <strong>登录<a href="https://github.com/git/git/releases%E6%9F%A5%E7%9C%8Bgit%E7%9A%84%E6%9C%80%E6%96%B0%E7%89%88%E3%80%82%E4%B8%8D%E8%A6%81%E4%B8%8B%E8%BD%BD%E5%B8%A6%E6%9C%89-rc%E7%9A%84%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%AE%83%E4%BB%A3%E8%A1%A8%E4%BA%86%E4%B8%80%E4%B8%AA%E5%80%99%E9%80%89%E5%8F%91%E5%B8%83%E7%89%88%E6%9C%AC">https://github.com/git/git/releases查看git的最新版。不要下载带有-rc的，因为它代表了一个候选发布版本</a></strong></p>
<ul>
<li>编译</li>
</ul>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost git-2.19.0]# cd git-2.19.0/</span><br><span class="line">[root@localhost git-2.19.0]# make configure</span><br><span class="line">[root@localhost git-2.19.0]# ./configure --prefix=/usr/local/git</span><br><span class="line">[root@localhost git-2.19.0]# make &amp;&amp; make install</span><br><span class="line">[root@localhost git-2.19.0]# export PATH=&quot;/usr/local/git/bin:$PATH&quot; </span><br><span class="line">[root@localhost git-2.19.0]# source /etc/profile</span><br><span class="line">[root@localhost git-2.19.0]# git --version </span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<h3 id="安装-maven"><a href="#安装-maven" class="headerlink" title="安装 maven"></a>安装 maven</h3><ul>
<li><p>下载maven<a href="http://maven.apache.org/download.cgi">地址</a></p>
</li>
<li><p>解压至 <code>/usr/local</code></p>
</li>
<li><p>设置环境变量并使其立即生效</p>
</li>
<li><p><code>mvn -v</code> 验证</p>
</li>
</ul>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># MAVEN</span><br><span class="line">export MAVEN_HOME=/usr/local/apache-maven-3.5.4</span><br><span class="line">export MAVEN_HOME</span><br><span class="line">export PATH=$PATH:$MAVEN_HOME/bin</span><br></pre></td></tr></table></figure>

<h3 id="安装-Tomcat"><a href="#安装-Tomcat" class="headerlink" title="安装 Tomcat"></a>安装 Tomcat</h3><ul>
<li>下载安装包，选择9.0.12版本</li>
</ul>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# wget http://mirrors.hust.edu.cn/apache/tomcat/tomcat-9/v9.0.12/bin/apache-tomcat-9.0.12.tar.gz</span><br><span class="line">--2018-09-26 10:38:25--  http://mirrors.hust.edu.cn/apache/tomcat/tomcat-9/v9.0.12/bin/apache-tomcat-9.0.12.tar.gz</span><br><span class="line">Resolving mirrors.hust.edu.cn (mirrors.hust.edu.cn)... 202.114.18.160</span><br><span class="line">Connecting to mirrors.hust.edu.cn (mirrors.hust.edu.cn)|202.114.18.160|:80... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 9912675 (9.5M) [application/octet-stream]</span><br><span class="line">Saving to: ‘apache-tomcat-9.0.12.tar.gz’</span><br></pre></td></tr></table></figure>

<ul>
<li>解压并移至<code>/usr/local</code>目录。</li>
</ul>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# tar -xzvf apache-tomcat-9.0.12.tar.gz </span><br><span class="line">[root@localhost ~]# mv apache-tomcat-9.0.12 /usr/local/apache-tomcat-9.0.12</span><br></pre></td></tr></table></figure>

<ul>
<li>创建软连接 </li>
</ul>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 软连接类似Windows的快捷方式</span><br><span class="line">[root@localhost ~]# ln -s /usr/local/apache-tomcat-9.0.12 /usr/local/tomcat</span><br></pre></td></tr></table></figure>

<ul>
<li>修改默认Tomcat端口</li>
</ul>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# vi /usr/local/tomcat/conf/server.xml</span><br><span class="line">...</span><br><span class="line">&lt;Connector port=&quot;10000&quot; protocol=&quot;HTTP/1.1&quot;</span><br><span class="line">   connectionTimeout=&quot;20000&quot; redirectPort=&quot;8443&quot; /&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>  默认端口8080，修改为10000</p>
<ul>
<li>启动</li>
</ul>
<p>  <code>/usr/local/tomcat/bin/startup.sh</code> </p>
<p>  使用 <a href="http://IP:PORT">http://IP:PORT</a> 访问。    </p>
<blockquote>
<p>如果启动正常，但无法正常访问。(ping可以，端口telnet不通)<br>需要关闭防火墙或开放指定端口</p>
</blockquote>
<p>  <strong>关闭防火墙 (CentOS 7)</strong></p>
<ul>
<li>启动： systemctl start firewalld</li>
<li>重启： systemctl restart firewalld.service</li>
<li>关闭： systemctl stop firewalld</li>
<li>查看状态： systemctl status firewalld </li>
<li>开机禁用  ： systemctl disable firewalld</li>
<li>开机启用  ： systemctl enable firewalld</li>
</ul>
<p>  <strong>开放指定端口</strong></p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">## --zone=public：表示作用域为公共的；</span><br><span class="line">## --add-port=8080/tcp：添加tcp协议的端口8080；</span><br><span class="line">## --permanent：永久生效，如果没有此参数，则只能维持当前服务生命周期内，重新启动后失效；</span><br><span class="line">[root@localhost local]# firewall-cmd --zone=public --add-port=10380/tcp --permanent;</span><br><span class="line">success</span><br><span class="line">## 重启防火墙</span><br><span class="line">[root@localhost local]# systemctl restart firewalld.service</span><br><span class="line">[root@localhost local]# </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="安装-Jenkins"><a href="#安装-Jenkins" class="headerlink" title="安装 Jenkins"></a>安装 Jenkins</h3><ul>
<li><p>下载war包<a href="http://mirrors.jenkins.io/war-stable/latest/jenkins.war">地址</a></p>
</li>
<li><p>上传war包到<code>/usr/local/tomcat/webapps/</code>目录。</p>
</li>
<li><p>重启tomcat.</p>
</li>
<li><p><code>http://IP:PORT/jenkins/</code> 访问jenkins。</p>
</li>
<li><p><code>/root/.jenkins/secrets/initialAdminPassword</code> 复制密码 解锁Jenkins。</p>
</li>
<li><p>安装社区推荐的插件。</p>
</li>
</ul>
<p>  <strong>设置管理员密码</strong></p>
<p>  admin/admin</p>
<blockquote>
<p>设置完密码以后，使用设置的管理员密码登录，访问jenkins，白页面。猜测可能与端口设置有关，<br>修改端口为10380后，重启tomcat，可以正常访问。</p>
</blockquote>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>  到此，我们的Jenkins环境就安装完成，后面我们将安装部分插件并使用git+maven构建任务。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://www.cnblogs.com/liugh/p/6623530.html">Linux下安装Java（JDK8）</a></li>
<li><a href="https://blog.csdn.net/Juladoe/article/details/76170193">CentOS7安装最新版git教程</a></li>
<li><a href="https://www.cnblogs.com/moxiaoan/p/5683743.html">CentOS7使用firewalld打开关闭防火墙与端口</a>  </li>
<li><a href="https://www.cnblogs.com/yuhebin/p/8594774.html">Linux安装Tomcat</a>  </li>
<li><a href="https://blog.csdn.net/andyzhaojianhui/article/details/73472500">linux下安装及配置jenkins</a>  </li>
</ul>
]]></content>
      <categories>
        <category>软件安装</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Jmeter安装与使用</title>
    <url>/2021/05/28/Jmeter%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h3 id="Jmeter的安装"><a href="#Jmeter的安装" class="headerlink" title="Jmeter的安装"></a>Jmeter的安装</h3><h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><p>[<a href="http://jmeter.apache.org/download_jmeter.cgi">官网</a>]</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210528163050542.png" alt="image-20210528163050542"></p>
<p>下载后直接解压即可。</p>
<span id="more"></span>

<p>其他博客讲要配置Jmeter的环境变量，我这里没有配置，直接运行jmeter.bat启动成功了。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210528163522940.png" alt="image-20210528163522940"></p>
<h4 id="设置中文"><a href="#设置中文" class="headerlink" title="设置中文"></a>设置中文</h4><p>Options -&gt; Choose Language -&gt; Chinese(Simplified)</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210528163625845.png" alt="image-20210528163625845"></p>
<h3 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h3><p>右键Test Plan创建一个线程组</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210528164520982.png" alt="image-20210528164520982"></p>
<p>线程组包含线程数、Ream-Up时间、循环次数等设置。暂时我们使用默认值。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210528164759882.png" alt="image-20210528164759882"></p>
<p>右键线程组，添加取样器，选中HTTP请求</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210528164909173.png" alt="image-20210528164909173"></p>
<p>我们配置了一个简单的HTTP请求：</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210528164947516.png" alt="image-20210528164947516"></p>
<p>然后右键线程组，添加监听器选择一个 查看结果树</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210528165023537.png" alt="image-20210528165023537"></p>
<p>选中我们的线程组，点击上方绿色执行按钮，执行。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210528165133177.png" alt="image-20210528165133177"></p>
<p>然后选择查看结果树，就可以看到执行结果了</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210528165204344.png" alt="image-20210528165204344"></p>
<p>是不是很方便。</p>
<p><strong>修改编码</strong></p>
<p>仔细看会发现我们的响应中有乱码消息，这个是Jmeter默认ISO-9959-1编码造成的。关闭软件，找到bin目录下的jmeter.properties，找到sampleresult.default.encoding这个，放开注释，将ISO-9959-1替换为UTF-8,如图：</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210528165440684.png" alt="image-20210528165440684"></p>
<p>重启Jmeter再执行乱码问题已经处理掉了。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210528165611784.png" alt="image-20210528165611784"></p>
]]></content>
      <categories>
        <category>软件安装</category>
      </categories>
      <tags>
        <tag>Jmeter</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux安装教程之Redis的安装</title>
    <url>/2021/06/21/Linux%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B%E4%B9%8BRedis%E7%9A%84%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<h3 id="下载安装包"><a href="#下载安装包" class="headerlink" title="下载安装包"></a>下载安装包</h3><p>下载地址：<a href="https://redis.io/download">https://redis.io/download</a></p>
<p>当前最新版本6.2.4，下载并按照。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget https://download.redis.io/releases/redis-6.2.4.tar.gz</span><br><span class="line">tar xzf redis-6.2.4.tar.gz</span><br><span class="line">cd redis-6.2.4</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<p>编译后，src目录执行即可。</p>
<span id="more"></span>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./bin/redis-server</span><br></pre></td></tr></table></figure>

<p>如果需要后台启动，修改redis.conf</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210621155558248.png" alt="image-20210621155558248"></p>
<p>重新./redis-server redis.conf启动，即可。</p>
<p>ps -ef|grep redis可以查看是否启动成功。</p>
]]></content>
      <categories>
        <category>软件安装</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Maven编译生成war包</title>
    <url>/2021/08/12/Maven%E7%BC%96%E8%AF%91%E7%94%9F%E6%88%90war%E5%8C%85/</url>
    <content><![CDATA[<blockquote>
<p>接手项目平时的构建都是手动上传编译后的文件，比较麻烦。这里梳理构建war包的过程并记录构建中遇到的各类问题。</p>
</blockquote>
<h2 id="构建war包"><a href="#构建war包" class="headerlink" title="构建war包"></a>构建war包</h2><ol>
<li><p>mvn clean package 打包报错，“编码GBK的不可映射字符”。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210812101658940.png" alt="image-20210812101658940"></p>
<p>检查步骤：</p>
<span id="more"></span>

<p>确保idea的设置都是UTF-8编码。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210812102153378.png" alt="image-20210812102153378"></p>
<p>   确保pom文件中已添加UTF-8的配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span>		</span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我这里在添加pom的配置后，就已经解决了。</p>
</li>
<li><p>mvn clean package 打包报错，“程序包com.alipay.demo.trade.service.impl不存在”</p>
<p>这个报错是因为我的maven项目引入了本地的jar包。pom引入本地文件即可。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alipay<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>alipay-trade-sdk-20161215<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>system<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">systemPath</span>&gt;</span>$&#123;project.basedir&#125;/src/main/webapp/WEB-INF/lib/alipay-trade-sdk-20161215.jar<span class="tag">&lt;/<span class="name">systemPath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="配置多环境文件"><a href="#配置多环境文件" class="headerlink" title="配置多环境文件"></a>配置多环境文件</h2><p>找出多环境下配置文件的差异，新建dev、prod等目录。针对不同环境打包不同环境的配置。</p>
<p>添加环境配置与拷贝配置文件的插件</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">package.environment</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">package.environment</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>prod<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">package.environment</span>&gt;</span>prod<span class="tag">&lt;/<span class="name">package.environment</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-resources-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>copy-resources<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>copy-resources<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 覆盖原有文件 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">overwrite</span>&gt;</span>true<span class="tag">&lt;/<span class="name">overwrite</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>$&#123;project.build.outputDirectory&#125;<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 也可以用下面这样的方式（指定相对url的方式指定outputDirectory） &lt;outputDirectory&gt;target/classes&lt;/outputDirectory&gt; --&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 待处理的资源定义 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 指定resources插件处理哪个目录下的资源文件 --&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!--suppress UnresolvedMavenProperty --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources/$&#123;package.environment&#125;<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>false<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这样再执行打包的时候：mvn clean package -Pprod即可将配置文件打包到war包内了。</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="pom内置属性"><a href="#pom内置属性" class="headerlink" title="pom内置属性"></a>pom内置属性</h3><p>比如一个maven项目名为：maven-demo</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>含义</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>${project.basedir}</td>
<td>包含pom文件的目录</td>
<td>maven-demo/</td>
</tr>
<tr>
<td>${project.build.sourceDirectory}</td>
<td>项目主源码目录</td>
<td>src/main/java</td>
</tr>
<tr>
<td>${project.build.outputDirectory}</td>
<td>构建过程输出目录</td>
<td>target/classes</td>
</tr>
<tr>
<td>${project.build.finalName}</td>
<td>build结果名称</td>
<td>缺省为${project.artifactId}-${project.version}</td>
</tr>
<tr>
<td>${project.packaging}</td>
<td>打包类型</td>
<td>缺省为jar</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
]]></content>
      <tags>
        <tag>Maven</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL常用命令</title>
    <url>/2021/09/07/MySQL%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<ol>
<li><p>统计近7天的某数据，无数据时补0。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	<span class="variable">@cdate</span> :<span class="operator">=</span> date_add( <span class="variable">@cdate</span>, <span class="type">INTERVAL</span> <span class="operator">-</span> <span class="number">1</span> <span class="keyword">DAY</span> ) <span class="type">date</span> </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	( <span class="keyword">SELECT</span> <span class="variable">@cdate</span> :<span class="operator">=</span> date_add( CURDATE( ), <span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">DAY</span> ) <span class="keyword">FROM</span> rp_notice LIMIT <span class="number">7</span> ) a</span><br></pre></td></tr></table></figure></li>
<li><p>todo </p>
</li>
</ol>
]]></content>
      <categories>
        <category>常用命令</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Python模块学习之BeautifulSoup使用</title>
    <url>/2021/09/07/Python%E6%A8%A1%E5%9D%97%E5%AD%A6%E4%B9%A0%E4%B9%8BBeautifulSoup/</url>
    <content><![CDATA[<blockquote>
<p>BeautifulSoup简称Bs4，是爬虫非常常用的三方库。</p>
</blockquote>
<p><a href="https://beautifulsoup.readthedocs.io/zh_CN/v4.4.0/#id7">中文文档</a></p>
<h3 id="安装BS4"><a href="#安装BS4" class="headerlink" title="安装BS4"></a>安装BS4</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># pip 安装方式</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pip install beautifulsoup4</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pip install lxml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pip install html5lib</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># easy_install</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> easy_install beautifulsoup4</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> easy_install lxml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> easy_install html5lib</span></span><br></pre></td></tr></table></figure>

<p>lxml 与html5lib都是第三方的HTML解析器。</p>
<h3 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">html_doc = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;html&gt;&lt;head&gt;&lt;title&gt;The Dormouse&#x27;s story&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;p class=&quot;title&quot;&gt;&lt;b&gt;The Dormouse&#x27;s story&lt;/b&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;p class=&quot;story&quot;&gt;</span></span><br><span class="line"><span class="string"> 	Once upon a time there were three little sisters; and their names were</span></span><br><span class="line"><span class="string"> &lt;a href=&quot;http://example.com/elsie&quot; class=&quot;sister&quot; id=&quot;link1&quot;&gt;Elsie&lt;/a&gt;,</span></span><br><span class="line"><span class="string"> &lt;a href=&quot;http://example.com/lacie&quot; class=&quot;sister&quot; id=&quot;link2&quot;&gt;Lacie&lt;/a&gt; and</span></span><br><span class="line"><span class="string"> &lt;a href=&quot;http://example.com/tillie&quot; class=&quot;sister&quot; id=&quot;link3&quot;&gt;Tillie&lt;/a&gt;;</span></span><br><span class="line"><span class="string"> and they lived at the bottom of a well.</span></span><br><span class="line"><span class="string">&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;p class=&quot;story&quot;&gt;...&lt;/p&gt;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line">soup = BeautifulSoup(html_doc, <span class="string">&#x27;lxml&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>简单使用</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; soup.title</span><br><span class="line">&lt;title&gt;The Dormouse<span class="string">&#x27;s story&lt;/title&gt;</span></span><br><span class="line"><span class="string">&gt;&gt;&gt; soup.title.name</span></span><br><span class="line"><span class="string">&#x27;</span>title<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&gt;&gt;&gt; soup.title.get_text()</span></span><br><span class="line"><span class="string">&quot;The Dormouse&#x27;</span>s story<span class="string">&quot;</span></span><br><span class="line"><span class="string">&gt;&gt;&gt; soup.title.parent</span></span><br><span class="line"><span class="string">&lt;head&gt;&lt;title&gt;The Dormouse&#x27;s story&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">&gt;&gt;&gt; soup.title.parent.name</span></span><br><span class="line"><span class="string">&#x27;head&#x27;</span></span><br></pre></td></tr></table></figure>

<p>找到所有a标签的链接</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; soup.a</span><br><span class="line">&lt;a <span class="class"><span class="keyword">class</span>=&quot;<span class="title">sister</span>&quot; <span class="title">href</span>=&quot;<span class="title">http</span>://<span class="title">example</span>.<span class="title">com</span>/<span class="title">elsie</span>&quot; <span class="title">id</span>=&quot;<span class="title">link1</span>&quot;&gt;<span class="title">Elsie</span>&lt;/<span class="title">a</span>&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">m</span> = [ <span class="title">o</span>[&#x27;<span class="title">href</span>&#x27;] <span class="title">for</span> <span class="title">o</span> <span class="title">in</span> <span class="title">soup</span>.<span class="title">find_all</span>(&#x27;<span class="title">a</span>&#x27;) ]</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">m</span></span></span><br><span class="line"><span class="class">[&#x27;<span class="title">http</span>://<span class="title">example</span>.<span class="title">com</span>/<span class="title">elsie</span>&#x27;, &#x27;<span class="title">http</span>://<span class="title">example</span>.<span class="title">com</span>/<span class="title">lacie</span>&#x27;, &#x27;<span class="title">http</span>://<span class="title">example</span>.<span class="title">com</span>/<span class="title">tillie</span>&#x27;]</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">n</span> = [ <span class="title">o</span>.<span class="title">get</span>(&#x27;<span class="title">href</span>&#x27;) <span class="title">for</span> <span class="title">o</span> <span class="title">in</span> <span class="title">soup</span>.<span class="title">find_all</span>(&#x27;<span class="title">a</span>&#x27;) ]</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">n</span></span></span><br><span class="line"><span class="class">[&#x27;<span class="title">http</span>://<span class="title">example</span>.<span class="title">com</span>/<span class="title">elsie</span>&#x27;, &#x27;<span class="title">http</span>://<span class="title">example</span>.<span class="title">com</span>/<span class="title">lacie</span>&#x27;, &#x27;<span class="title">http</span>://<span class="title">example</span>.<span class="title">com</span>/<span class="title">tillie</span>&#x27;]</span></span><br></pre></td></tr></table></figure>

<h3 id="CSS选择器"><a href="#CSS选择器" class="headerlink" title="CSS选择器"></a>CSS选择器</h3><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; soup.select(<span class="string">&quot;body p a&quot;</span>)   <span class="comment"># 逐级查找</span></span><br><span class="line">&gt;&gt;&gt; soup.select(<span class="string">&quot;p &gt; a&quot;</span>)	  <span class="comment"># 直接找到标签下的子标签 </span></span><br><span class="line">[&lt;<span class="type">a</span> <span class="type">class</span>=<span class="string">&quot;sister&quot;</span> <span class="type">href</span>=<span class="string">&quot;http://example.com/elsie&quot;</span> <span class="type">id</span>=<span class="string">&quot;link1&quot;</span>&gt;<span class="type">Elsie</span>&lt;/<span class="type">a</span>&gt;, &lt;<span class="type">a</span> <span class="type">class</span>=<span class="string">&quot;sister&quot;</span> <span class="type">href</span>=<span class="string">&quot;http://example.com/lacie&quot;</span> <span class="type">id</span>=<span class="string">&quot;link2&quot;</span>&gt;<span class="type">Lacie</span>&lt;/<span class="type">a</span>&gt;, &lt;<span class="type">a</span> <span class="type">class</span>=<span class="string">&quot;sister&quot;</span> <span class="type">href</span>=<span class="string">&quot;http://example.com/tillie&quot;</span> <span class="type">id</span>=<span class="string">&quot;link3&quot;</span>&gt;<span class="type">Tillie</span>&lt;/<span class="type">a</span>&gt;]</span><br><span class="line">&gt;&gt;&gt; soup.select(<span class="string">&quot;#link1 ~ .sister&quot;</span>)	<span class="comment">#后续兄弟节点选择器</span></span><br><span class="line">[&lt;<span class="type">a</span> <span class="type">class</span>=<span class="string">&quot;sister&quot;</span> <span class="type">href</span>=<span class="string">&quot;http://example.com/lacie&quot;</span> <span class="type">id</span>=<span class="string">&quot;link2&quot;</span>&gt;<span class="type">Lacie</span>&lt;/<span class="type">a</span>&gt;,</span><br><span class="line">&lt;<span class="type">a</span> <span class="type">class</span>=<span class="string">&quot;sister&quot;</span> <span class="type">href</span>=<span class="string">&quot;http://example.com/tillie&quot;</span>  <span class="type">id</span>=<span class="string">&quot;link3&quot;</span>&gt;<span class="type">Tillie</span>&lt;/<span class="type">a</span>&gt;]</span><br><span class="line">&gt;&gt;&gt; soup.select(<span class="string">&quot;#link1 + .sister&quot;</span>) <span class="comment"># 相邻兄弟节点选择器</span></span><br><span class="line">[&lt;<span class="type">a</span> <span class="type">class</span>=<span class="string">&quot;sister&quot;</span> <span class="type">href</span>=<span class="string">&quot;http://example.com/lacie&quot;</span> <span class="type">id</span>=<span class="string">&quot;link2&quot;</span>&gt;<span class="type">Lacie</span>&lt;/<span class="type">a</span>&gt;]</span><br></pre></td></tr></table></figure>

<h2 id="理论知识"><a href="#理论知识" class="headerlink" title="理论知识"></a>理论知识</h2><h3 id="对象种类"><a href="#对象种类" class="headerlink" title="对象种类"></a>对象种类</h3><p>Beautiful Soup将复杂HTML文档转换成一个复杂的树形结构,每个节点都是Python对象,所有对象可以归纳为4种:Tag<code>,</code>NavigableString<code>,</code>BeautifulSoup<code>,</code>Comment.</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; <span class="built_in">type</span>(soup.a)  <span class="comment"># Tag</span></span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">bs4</span>.<span class="title">element</span>.<span class="title">Tag</span>&#x27;&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">soup</span>.<span class="title">a</span>.<span class="title">name</span>	  # <span class="title">Name</span> 每个<span class="title">tag</span>都有自己的名字,使用.<span class="title">name</span>获取</span></span><br><span class="line"><span class="class">&#x27;<span class="title">a</span>&#x27;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">soup</span>.<span class="title">a</span>		 # <span class="title">Attributes</span> 一个<span class="title">tag</span>可能多个属性，诸如 <span class="title">class</span>/<span class="title">href</span>/<span class="title">id</span>等。</span></span><br><span class="line"><span class="class">&lt;<span class="title">a</span> <span class="title">class</span>=&quot;<span class="title">sister</span>&quot; <span class="title">href</span>=&quot;<span class="title">http</span>://<span class="title">example</span>.<span class="title">com</span>/<span class="title">elsie</span>&quot; <span class="title">id</span>=&quot;<span class="title">link1</span>&quot;&gt;<span class="title">Elsie</span>&lt;/<span class="title">a</span>&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">soup</span>.<span class="title">a</span>[&#x27;<span class="title">href</span>&#x27;]</span></span><br><span class="line"><span class="class">&#x27;<span class="title">http</span>://<span class="title">example</span>.<span class="title">com</span>/<span class="title">elsie</span>&#x27;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">soup</span>.<span class="title">a</span>[&#x27;<span class="title">class</span>&#x27;]</span></span><br><span class="line"><span class="class">[&#x27;<span class="title">sister</span>&#x27;]</span></span><br><span class="line"><span class="class">				# <span class="title">Comment</span>是一个特殊类型对象 像注释..</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">markup</span> = &quot;&lt;<span class="title">b</span>&gt;&lt;!--<span class="title">Hey</span>, <span class="title">buddy</span>. <span class="title">Want</span> <span class="title">to</span> <span class="title">buy</span> <span class="title">a</span> <span class="title">used</span> <span class="title">parser</span>?--&gt;&lt;/<span class="title">b</span>&gt;&quot;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">soup</span> = <span class="title">BeautifulSoup</span>(<span class="title">markup</span>)</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">comment</span> = <span class="title">soup</span>.<span class="title">b</span>.<span class="title">string</span></span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">type</span>(<span class="title">comment</span>)</span></span><br><span class="line"><span class="class"># &lt;<span class="title">class</span> &#x27;<span class="title">bs4</span>.<span class="title">element</span>.<span class="title">Comment</span>&#x27;&gt;</span></span><br></pre></td></tr></table></figure>





]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux常用命令</title>
    <url>/2021/05/14/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<h3 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h3><p><strong>查看防火墙状态</strong></p>
<p>systemctl status firewalld.service</p>
<p>firewall-cmd –state</p>
<p><strong>关闭防火墙</strong></p>
<p>systemctl stop firewalld.service</p>
<p><strong>开启防火墙</strong></p>
<p>systemctl start firewalld.service</p>
<p><strong>禁用防火墙</strong></p>
<p>systemctl disable firewalld.service</p>
<span id="more"></span>

<p><strong>设置开机自动启动</strong></p>
<p>systemctl enable firewalld.service</p>
<p> <strong>关闭开机启动</strong></p>
<p>systemctl disable firewalld.service</p>
<p><strong>查看防火墙所有开放的端口</strong></p>
<p>firewall-cmd –zone=public –list-ports</p>
<h3 id="查看系统版本"><a href="#查看系统版本" class="headerlink" title="查看系统版本"></a>查看系统版本</h3><p>cat /etc/redhat-release</p>
<h3 id="常见插件安装"><a href="#常见插件安装" class="headerlink" title="常见插件安装"></a>常见插件安装</h3><h4 id="sz-和-rz安装"><a href="#sz-和-rz安装" class="headerlink" title="sz 和 rz安装"></a>sz 和 rz安装</h4><p>yum install lrzsz</p>
<h3 id="删除乱码文件"><a href="#删除乱码文件" class="headerlink" title="删除乱码文件"></a>删除乱码文件</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ls -i   # 显示文件的节点号</span><br><span class="line">find -inum 3031169 -delete</span><br></pre></td></tr></table></figure>

<p>再看就已经成功删除了。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210530221326703.png" alt="image-20210530221326703"></p>
<h3 id="查看服务器占用空间"><a href="#查看服务器占用空间" class="headerlink" title="查看服务器占用空间"></a>查看服务器占用空间</h3><p><strong>df</strong></p>
<p>df可以查看根目录大小、使用比例及其挂入点。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210617094210820.png" alt="image-20210617094210820"></p>
<p><strong>du</strong></p>
<p>du可以查看文件及文件夹的大小。但目录层级过多的时候，列表数目过多并不利于查看。所以我们可以指定目录深度 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">du -h --max-depth=1 /usr/local</span><br></pre></td></tr></table></figure>



<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210617095002419.png" alt="image-20210617095002419"></p>
<h3 id="文件查找"><a href="#文件查找" class="headerlink" title="文件查找"></a>文件查找</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">find / -name http.conf  	# 在根目录下查找文件http.conf</span><br><span class="line">find / -name &#x27;name&#x27;		    # 在根目录查找文件名包含name的文件</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>SpringCloud学习 | 第一篇 构建项目</title>
    <url>/2021/05/12/SpringCloud%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%80%EF%BC%89%20%E6%9E%84%E5%BB%BA%E9%A1%B9%E7%9B%AE/</url>
    <content><![CDATA[<h2 id="SpringCloud-与-SpringBoot的版本"><a href="#SpringCloud-与-SpringBoot的版本" class="headerlink" title="SpringCloud 与 SpringBoot的版本"></a>SpringCloud 与 SpringBoot的版本</h2><p>因为SpringCloud与SpringBoot的版本需要对应，否则会出现异常。</p>
<p><a href="https://spring.io/projects/spring-cloud#learn">https://spring.io/projects/spring-cloud#learn</a> 查看目前的版本</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210512141013629.png" alt="image-20210512141013629"></p>
<p>点击Reference Doc，可以查看该版本对应的SpringBoot版本。</p>
<span id="more"></span>

<h2 id="构建父工程"><a href="#构建父工程" class="headerlink" title="构建父工程"></a>构建父工程</h2><p>Idea创建一个Maven项目，选择quickstart，输入你的groupId和artifactId创建一个父工程。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210512141348116.png" alt="image-20210512141348116"></p>
<p>父工程仅保留pom文件即可，所以我们删除src目录并修改pom文件，添加版本依赖。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ruipin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ruipin-cloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>ruipin-cloud<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">description</span>&gt;</span>睿聘Cloud<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">ruipin.version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">ruipin.version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>2020.0.2<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">spring-cloud-alibaba.version</span>&gt;</span>2020.0.RC1<span class="tag">&lt;/<span class="name">spring-cloud-alibaba.version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">lombok.version</span>&gt;</span>1.18.18<span class="tag">&lt;/<span class="name">lombok.version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">hutool.version</span>&gt;</span>5.5.8<span class="tag">&lt;/<span class="name">hutool.version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>8.0.19<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">druid.version</span>&gt;</span>1.2.4<span class="tag">&lt;/<span class="name">druid.version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">mybatis-plus.version</span>&gt;</span>3.4.2<span class="tag">&lt;/<span class="name">mybatis-plus.version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">minio.version</span>&gt;</span>7.1.0<span class="tag">&lt;/<span class="name">minio.version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">knife4j.version</span>&gt;</span>2.0.8<span class="tag">&lt;/<span class="name">knife4j.version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">redisson.version</span>&gt;</span>3.15.1<span class="tag">&lt;/<span class="name">redisson.version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">swagger.version</span>&gt;</span>1.6.2<span class="tag">&lt;/<span class="name">swagger.version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;lombok.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;hutool.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">			<span class="comment">&lt;!--Spring Cloud 相关依赖--&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">&lt;!--Spring Cloud &amp; Alibaba 相关依赖--&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud-alibaba.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">			<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.minio<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>minio<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;minio.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">			<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mysql.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">			<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;druid.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">			<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis-plus.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">			<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;knife4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">			<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>knife4j-micro-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;knife4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">			<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>knife4j-spring-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;knife4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">&lt;!-- 分布式锁 --&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;redisson.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">			<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.swagger<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swagger-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;swagger.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>到此，一个父工程就创建完毕了。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210512141721341.png" alt="image-20210512141721341"></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>接下来我们开始搭建Nacos服务。</p>
]]></content>
      <categories>
        <category>SpringCloud从零开始构建微服务</category>
      </categories>
      <tags>
        <tag>SpringCloud</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud学习 | 第七篇 Sentinel实现熔断与限流</title>
    <url>/2021/05/26/SpringCloud%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%83%EF%BC%89%20Sentinel%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E9%99%90%E6%B5%81/</url>
    <content><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Sentinel 以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。</p>
<p>Sentinel 具有以下特征:</p>
<ul>
<li><strong>丰富的应用场景</strong>：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</li>
<li><strong>完备的实时监控</strong>：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</li>
<li><strong>广泛的开源生态</strong>：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。</li>
<li><strong>完善的 SPI 扩展点</strong>：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</li>
</ul>
<span id="more"></span>

<p>Sentinel 的主要特性：</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210526175900928.png" alt="image-20210526175900928"></p>
<p>Sentinel 分为两个部分:</p>
<ul>
<li>核心库（Java 客户端）不依赖任何框架/库，能够运行于所有 Java 运行时环境，同时对 Dubbo / Spring Cloud 等框架也有较好的支持。</li>
<li>控制台（Dashboard）基于 Spring Boot 开发，打包后可以直接运行，不需要额外的 Tomcat 等应用容器。</li>
</ul>
<h3 id="启动控制台"><a href="#启动控制台" class="headerlink" title="启动控制台"></a>启动控制台</h3><blockquote>
<p>Sentinel 提供一个轻量级的开源控制台，它提供机器发现以及健康情况管理、监控（单机和集群），规则管理和推送的功能。</p>
</blockquote>
<p><a href="https://github.com/alibaba/Sentinel/releases%E7%9B%B4%E6%8E%A5%E4%B8%8B%E8%BD%BD%E6%9C%80%E6%96%B0jar%E6%96%87%E4%BB%B6%EF%BC%8C%E6%88%91%E4%B8%8B%E8%BD%BD%E7%9A%84[sentinel-dashboard-1.8.1.jar](https://github.com/alibaba/Sentinel/releases/download/1.8.1/sentinel-dashboard-1.8.1.jar)%E3%80%82">https://github.com/alibaba/Sentinel/releases直接下载最新jar文件，我下载的[sentinel-dashboard-1.8.1.jar](https://github.com/alibaba/Sentinel/releases/download/1.8.1/sentinel-dashboard-1.8.1.jar)。</a></p>
<p>或者下载源码，mvn clean package 构建一个fat jar。</p>
<p>命令行输入如下命令，运行Sentinel控制台。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java -jar -Dserver.port=8080 sentinel-dashboard-1.8.1.jar</span><br><span class="line"># PowerShell下需要在参数上加单引号</span><br><span class="line">java -jar ‘-Dserver.port=8080’ sentinel-dashboard-1.8.1.jar</span><br></pre></td></tr></table></figure>

<p>启动成功后，<a href="http://localhost:8080，访问，使用sentinel/sentinel登录。">http://localhost:8080，访问，使用sentinel/sentinel登录。</a></p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210527140431925.png" alt="image-20210527140431925"></p>
<p>登录以后是个大白控制页面。</p>
<h3 id="SpringCloud-服务整合Sentinel"><a href="#SpringCloud-服务整合Sentinel" class="headerlink" title="SpringCloud 服务整合Sentinel"></a>SpringCloud 服务整合Sentinel</h3><p>此处以我们早先的ruipin-demo服务来做整合测试。添加spring-cloud-starter-alibaba-sentinel依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Sentinel --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加Sentinel配置</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ruipin-demo</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">http://localhost:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">$&#123;spring.cloud.nacos.discovery.server-addr&#125;</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8010</span> <span class="comment"># 应用与sentinel控制台交互的端口</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8030</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">sentinel:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>创建一个http请求接口</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/demo&quot;)</span><br><span class="line">public class DemoController &#123;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;/sayHello/&#123;name&#125;&quot;)</span><br><span class="line">    public Result sayHello(@PathVariable String name)&#123;</span><br><span class="line">        return Result.success(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到此一个简单的整合就结束了。启动服务后，我们调用接口，并刷新Sentinel控制台。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210527141326503.png" alt="image-20210527141326503"></p>
<p>实时监控就已经可以看到请求了</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210527141427650.png" alt="image-20210527141427650"></p>
<h3 id="配置限流"><a href="#配置限流" class="headerlink" title="配置限流"></a>配置限流</h3><p>增加流控。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210527150323961.png" alt="image-20210527150323961"></p>
<p>也可以再流控规则里直接添加。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210527150425668.png" alt="image-20210527150425668"></p>
<p>再次调用接口，频繁刷新，会出现限流的默认信息</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210527150548550.png" alt="image-20210527150548550"></p>
<h3 id="自定义限流信息"><a href="#自定义限流信息" class="headerlink" title="自定义限流信息"></a>自定义限流信息</h3><p>实现默认的BlockExceptionHandler接口，重写限流信息。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoBlockHandlerException</span> <span class="keyword">implements</span> <span class="title">BlockExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, BlockException e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        httpServletResponse.setHeader(<span class="string">&quot;Content-Type&quot;</span>,<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        String message = <span class="string">&quot;&#123;\&quot;code\&quot;:999,\&quot;msg\&quot;:\&quot;访问人数过多\&quot;&#125;&quot;</span>;</span><br><span class="line">        httpServletResponse.getWriter().write(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重新执行接口请求，重启后会发现流控规则已经没有了，需要重新配置。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210527153656869.png" alt="image-20210527153656869"></p>
<h3 id="使用Nacos存储规则"><a href="#使用Nacos存储规则" class="headerlink" title="使用Nacos存储规则"></a>使用Nacos存储规则</h3><p>这里我们还是使用demo模块，添加Pom依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>补充配置，增加Nacos数据源配置</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8010</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8030</span></span><br><span class="line">      <span class="attr">datasource:</span></span><br><span class="line">        <span class="attr">ds1:</span></span><br><span class="line">          <span class="attr">nacos:</span></span><br><span class="line">            <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">            <span class="attr">dataId:</span> <span class="string">$&#123;spring.application.name&#125;-sentinel</span></span><br><span class="line">            <span class="attr">groupId:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line">            <span class="attr">data-type:</span> <span class="string">json</span></span><br><span class="line">            <span class="attr">rule-type:</span> <span class="string">flow</span></span><br></pre></td></tr></table></figure>

<p>Nacos中添加配置</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210528175815289.png" alt="image-20210528175815289"></p>
<p>Json内容：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;resource&quot;</span>: <span class="string">&quot;/demo/jiang/&#123;username&#125;&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;limitApp&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;grade&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;count&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;strategy&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;controlBehavior&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;clusterMode&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>配置信息说明：</p>
<ul>
<li>resource 资源名称</li>
<li>limitApp 来源应用</li>
<li>grade 阈值类型 0 表示线程数，1表示QPS</li>
<li>count 单机阈值</li>
<li>strategy：流控模式 0 表示直接，1表示关联 2表示链路</li>
<li>controlBehavior 流控效果 0 快速是吧 1表示warm up 2 表示排队</li>
<li>clusterMode 是否集群</li>
</ul>
<p>发布以后，我们启动Sentinel 和 demo服务，因为我们目前的Sentinel是懒加载，所以需要手动执行请求<a href="http://localhost:8050/demo/jiang/abcdsd">http://localhost:8050/demo/jiang/abcdsd</a> 然后发现Sentinel的配置已经同步过来了。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210528180747821.png" alt="image-20210528180747821"></p>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><ul>
<li>[<a href="https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D">https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D</a>]</li>
<li>[<a href="http://www.macrozheng.com/]">http://www.macrozheng.com/]</a></li>
<li>[<a href="http://www.macrozheng.com/#/cloud/sentinel]">http://www.macrozheng.com/#/cloud/sentinel]</a></li>
</ul>
]]></content>
      <categories>
        <category>SpringCloud从零开始构建微服务</category>
      </categories>
      <tags>
        <tag>SpringCloud</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud学习 | 第九篇 微服务部署</title>
    <url>/2021/06/21/SpringCloud%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B9%9D%EF%BC%89%20%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<h3 id="Jekins安装"><a href="#Jekins安装" class="headerlink" title="Jekins安装"></a>Jekins安装</h3><h4 id="Windows下的安装"><a href="#Windows下的安装" class="headerlink" title="Windows下的安装"></a>Windows下的安装</h4><h4 id="Linux下的安装"><a href="#Linux下的安装" class="headerlink" title="Linux下的安装"></a>Linux下的安装</h4><h3 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h3><h4 id="Pom依赖"><a href="#Pom依赖" class="headerlink" title="Pom依赖"></a>Pom依赖</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;build&gt;</span><br><span class="line">  &lt;plugins&gt;</span><br><span class="line">    &lt;plugin&gt;</span><br><span class="line">       &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">       &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">       &lt;configuration&gt;</span><br><span class="line">         &lt;executable&gt;true&lt;/executable&gt;</span><br><span class="line">       &lt;/configuration&gt;</span><br><span class="line">    &lt;/plugin&gt;</span><br><span class="line">  &lt;/plugins&gt;</span><br><span class="line">&lt;/build&gt;</span><br></pre></td></tr></table></figure>

<p>mvn clean package -Dskip.test=true 构建fat-jar</p>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3>]]></content>
      <categories>
        <category>SpringCloud从零开始构建微服务</category>
      </categories>
      <tags>
        <tag>SpringCloud</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud学习 | 第三篇 SpringCloud整合Nacos实现配置中心</title>
    <url>/2021/05/14/SpringCloud%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%89%EF%BC%89%20Nacos%E5%AE%9E%E7%8E%B0%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/</url>
    <content><![CDATA[<blockquote>
<p>接上述文章，我们在auth模块中使用Nacos实现配置中心。</p>
</blockquote>
<h3 id="一段废话"><a href="#一段废话" class="headerlink" title="一段废话"></a>一段废话</h3><p>相比Eureka要专门搭建一个config服务实现配置中心，Nacos集成了配置中心。个人觉得还是值得推荐。</p>
<h3 id="SpringCloud实现配置中心"><a href="#SpringCloud实现配置中心" class="headerlink" title="SpringCloud实现配置中心"></a>SpringCloud实现配置中心</h3><h4 id="添加pom依赖"><a href="#添加pom依赖" class="headerlink" title="添加pom依赖"></a>添加pom依赖</h4><p>相比上一文，我们追加了一个spring-cloud-starter-alibaba-nacos-config依赖。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- SpringCloud从2020版本后对配置文件加载进行了重构，</span></span><br><span class="line"><span class="comment">			默认不加载bootstrap配置文件，添加bootstrap依赖解决该问题 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 注册中心 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- nacos-config 配置中心依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h4 id="配置文件添加nacos配置"><a href="#配置文件添加nacos配置" class="headerlink" title="配置文件添加nacos配置"></a>配置文件添加nacos配置</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ruipin-auth</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">http://127.0.0.1:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span>      <span class="comment"># 默认值 properties</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span>      <span class="comment"># 默认值 DEFAULT_GROUP</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line"><span class="attr">example:</span></span><br><span class="line">  <span class="attr">hello-word:</span> <span class="string">Hello</span> <span class="string">Ruipin</span>		 <span class="comment"># 配置测试信息</span></span><br></pre></td></tr></table></figure>

<h4 id="添加测试接口读取配置"><a href="#添加测试接口读取配置" class="headerlink" title="添加测试接口读取配置"></a>添加测试接口读取配置</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/sample&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;example.hello-word&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String word;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">getWord</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.success(<span class="keyword">this</span>.word);<span class="comment">//Result为自定义响应，可以直接返回this.word字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>启动服务，第一次调用 <a href="http://localhost:8000/sample/hello">http://localhost:8000/sample/hello</a></p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210514161730557.png" alt="image-20210514161730557"></p>
<h4 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h4><p>打开Nacos界面，配置列表，添加配置：</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210514162229678.png" alt="image-20210514162229678"></p>
<p>Data ID: 输入 ${prefix}-${spring.profiles.active}.${file-extension}，根据我上面的配置，我的配置截图</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210514162723996.png" alt="image-20210514162723996"></p>
<p>点击发布，列表中出现一条配置。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210514162808803.png" alt="image-20210514162808803"></p>
<h4 id="再次测试"><a href="#再次测试" class="headerlink" title="再次测试"></a>再次测试</h4><p>第二次调用 <a href="http://localhost:8000/sample/hello%EF%BC%8C%E6%88%90%E5%8A%9F%E5%AE%9E%E7%8E%B0%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E7%9A%84%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0%E3%80%82">http://localhost:8000/sample/hello，成功实现配置信息的动态刷新。</a></p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210514162839536.png" alt="image-20210514162839536"></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>到此，SpringCloud整合Nacos实现配置中心就完成了。相比Eureka确实方便了很多。</p>
]]></content>
      <categories>
        <category>SpringCloud从零开始构建微服务</category>
      </categories>
      <tags>
        <tag>SpringCloud</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud学习 | 第二篇 SpringCloud整合Nacos实现注册中心</title>
    <url>/2021/05/14/SpringCloud%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%BA%8C%EF%BC%89%20Nacos%E5%AE%9E%E7%8E%B0%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/</url>
    <content><![CDATA[<blockquote>
<p>接上述文章，我们开始搭建Nacos服务。</p>
</blockquote>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p><strong>为什么要使用Nacos，不使用Eureka呢</strong></p>
<ol>
<li>Eureka只实现注册中心，nacos同时实现注册中心与配置中心。</li>
<li>Eureka2.0 闭源, Nacos国产各种中文文档。</li>
</ol>
<h3 id="搭建Nacos服务"><a href="#搭建Nacos服务" class="headerlink" title="搭建Nacos服务"></a>搭建Nacos服务</h3><h4 id="下载Nacos-server"><a href="#下载Nacos-server" class="headerlink" title="下载Nacos-server"></a>下载Nacos-server</h4><p><a href="https://github.com/alibaba/nacos/releases">GitHub地址</a> 。目前nacos-server的最新版本为2.0.1，不同版本可能些许差异。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210514105212761.png" alt="image-20210514105212761"></p>
<p>下载到本地目录并解压，我放在了我代码同级目录。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210514105651639.png" alt="image-20210514105651639"></p>
<span id="more"></span>

<h4 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h4><p>使用nacos\conf\nacos-mysql.sql脚本创建好数据库表和数据初始化。库名：nacos_config</p>
<h4 id="配置数据库连接"><a href="#配置数据库连接" class="headerlink" title="配置数据库连接"></a>配置数据库连接</h4><p>编辑nacos\conf/application.properties，修改自己本地的数据库连接信息    </p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210514110529653.png" alt="image-20210514110529653"></p>
<h4 id="启动nacos-server服务"><a href="#启动nacos-server服务" class="headerlink" title="启动nacos-server服务"></a>启动nacos-server服务</h4><p>☆ 确保本机已配置JAVA环境变量，版本8+</p>
<p>nacos\bin\下执行 startup.cmd -m standalone 启动。-m standalone代表单机模式。默认以集群模式启动。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210514112333044.png" alt="image-20210514112333044"></p>
<h4 id="进入nacos管理控制台"><a href="#进入nacos管理控制台" class="headerlink" title="进入nacos管理控制台"></a>进入nacos管理控制台</h4><p>启动服务后，登录控制台看看吧。地址: <a href="http://localhost:8848/nacos">http://localhost:8848/nacos</a>. 账号/密码: nacos/nacos</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210514112527620.png" alt="image-20210514112527620"></p>
<h3 id="SpringCloud整合Nacos"><a href="#SpringCloud整合Nacos" class="headerlink" title="SpringCloud整合Nacos"></a>SpringCloud整合Nacos</h3><h4 id="版本说明"><a href="#版本说明" class="headerlink" title="版本说明"></a>版本说明</h4><p>Nacos Server：2.0.1</p>
<p>SpringBoot：   2.4.5</p>
<p>SpringCloud： 2020.0.2</p>
<p>SpringCloud Alibaba：2021.1</p>
<p><a href="https://github.com/alibaba/spring-cloud-alibaba/wiki/%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E">版本依赖关系</a> </p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210514154208991.png" alt="image-20210514154208991"></p>
<h4 id="服务注册到Nacos"><a href="#服务注册到Nacos" class="headerlink" title="服务注册到Nacos"></a>服务注册到Nacos</h4><p>新建一个module，命名为ruipin-auth</p>
<p><strong>POM依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">     	<span class="comment">&lt;!-- SpringCloud从2020版本后对配置文件加载进行了重构，</span></span><br><span class="line"><span class="comment">			默认不加载bootstrap配置文件，添加bootstrap依赖解决该问题 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 注册中心 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>配置文件</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ruipin-auth</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">http://127.0.0.1:8848</span></span><br></pre></td></tr></table></figure>



<p><strong>启动入口开启服务发现</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(AuthApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>访问Nacos服务列表</strong>查看</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210514145800211.png" alt="image-20210514145800211"></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>到此SpringCloud整合Nacos注册中心就完成了，后面我们继续使用Nacos完成配置中心配置。</p>
]]></content>
      <categories>
        <category>SpringCloud从零开始构建微服务</category>
      </categories>
      <tags>
        <tag>SpringCloud</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud学习 | 第五篇 SpringCloud整合OpenFeign实现服务间调用</title>
    <url>/2021/05/15/SpringCloud%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%BA%94%EF%BC%89%20OpenFeign%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E9%97%B4%E8%B0%83%E7%94%A8/</url>
    <content><![CDATA[<h3 id="SpringCloud实现服务间调用"><a href="#SpringCloud实现服务间调用" class="headerlink" title="SpringCloud实现服务间调用"></a>SpringCloud实现服务间调用</h3><p>本文涉及模块</p>
<table>
<thead>
<tr>
<th>模块</th>
<th>端口</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Nacos server</td>
<td>8848</td>
<td>注册中心与配置中心</td>
</tr>
<tr>
<td>ruipin-auth</td>
<td>8000</td>
<td>服务调用方</td>
</tr>
<tr>
<td>ruipin-demo</td>
<td>8050</td>
<td>服务提供方</td>
</tr>
<tr>
<td>ruipin-demo-api</td>
<td>-</td>
<td>api模块，提供给auth引用</td>
</tr>
</tbody></table>
<h4 id="服务提供方"><a href="#服务提供方" class="headerlink" title="服务提供方"></a>服务提供方</h4><p>新建模块ruipin-application模块，管理所有业务功能。在application中建立ruipin-demo，提供服务。</p>
<span id="more"></span>

<p><strong>POM依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- SpringCloud从2020版本后对配置文件加载进行了重构，</span></span><br><span class="line"><span class="comment">    默认不加载bootstrap配置文件，添加bootstrap依赖解决该问题 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 注册中心 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置中心 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ruipin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ruipin-demo-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;ruipin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>配置文件</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8050</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ruipin-demo</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">http://localhost:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">$&#123;spring.cloud.nacos.discovery.server-addr&#125;</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>服务提供</strong></p>
<p>一个DemoController类，提供一个接口，返回信息。</p>
<p>一个启动入口类。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/demo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/sayHello/&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">sayHello</span><span class="params">(<span class="meta">@PathVariable</span> String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.success(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(DemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="服务的API"><a href="#服务的API" class="headerlink" title="服务的API"></a>服务的API</h4><p>在application模块中，建立子模块，ruipin-api-demo。提供feigin远程调用</p>
<p><strong>POM依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 远程调用HTTP客户端 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- openfeign依赖 1. http客户端选择okhttp 2. loadbalancer替换ribbon --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ruipin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>common-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;ruipin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>Feign调用</strong></p>
<p>创建Feign调用接口并提供一个降级回调服务。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;ruipin-demo&quot;, fallback = DemoFeignFallback.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DemoFeignClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/demo/sayHello/&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="function">Result&lt;String&gt; <span class="title">sayHello</span><span class="params">(<span class="meta">@PathVariable</span> String name)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoFeignFallback</span> <span class="keyword">implements</span> <span class="title">DemoFeignClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result&lt;String&gt; <span class="title">sayHello</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        log.error(<span class="string">&quot;feign远程调用系统用户服务异常后的降级方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Result.failed(ResultCode.DEGRADATION);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="服务调用方"><a href="#服务调用方" class="headerlink" title="服务调用方"></a>服务调用方</h4><p>ruipin-auth模块 基于之前的依赖，添加ruipin-demo-api依赖，全部依赖如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">     <span class="comment">&lt;!-- SpringCloud从2020版本后对配置文件加载进行了重构，</span></span><br><span class="line"><span class="comment">默认不加载bootstrap配置文件，添加bootstrap依赖解决该问题 --&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="comment">&lt;!-- 注册中心 --&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">&lt;!-- nacos-config 配置中心依赖--&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ruipin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>common-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;ruipin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ruipin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ruipin-demo-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;ruipin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>配置文件</strong></p>
<p>配置文件将feign底层调用修改为okhttp。全部配置内容有</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ruipin-auth</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">http://127.0.0.1:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span>      <span class="comment"># 默认值 properties</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span>      <span class="comment"># 默认值 DEFAULT_GROUP</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line"><span class="attr">example:</span></span><br><span class="line">  <span class="attr">hello-word:</span> <span class="string">Hello</span> <span class="string">Ruipin</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">okhttp:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><strong>服务调用代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="comment">// 开启feign调用</span></span><br><span class="line"><span class="comment">// *************重点**重点**重点**重点*************</span></span><br><span class="line"><span class="comment">// 如果FeignClient的包不在启动类的子包下，一定要添加扫描包，</span></span><br><span class="line"><span class="comment">// 比如@EnableFeignClients(&quot;com.xx.*&quot;)</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(AuthApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/sample&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DemoFeignClient demoFeignClient;</span><br><span class="line">	<span class="comment">//调用ruipin-demo的服务</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/sayHello/&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">sayHello</span><span class="params">(<span class="meta">@PathVariable</span> String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> demoFeignClient.sayHello(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>到此，我们的服务调用代码就整合完毕，依次启动nacos server、ruipin-auth、ruipin-demo三个模块。</p>
<p>打开localhost:8848/nacos，可以看到ruipin-auth和ruipin-demo服务已经启动</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210515114749158.png" alt="image-20210515114749158"></p>
<p>我们先直接调用demo的接口服务，调用正常。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210515114656194.png" alt="image-20210515114656194"></p>
<p>然后我们调用auth服务，也可以正常调用。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210515114902468.png" alt="image-20210515114902468"></p>
<h4 id="问题总结"><a href="#问题总结" class="headerlink" title="问题总结"></a>问题总结</h4><p><strong>Consider defining a bean of type ‘xxx’ in your config</strong></p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210528145021258.png" alt="image-20210528145021258"></p>
<p>服务调用方启动失败，报错找不到FeignClient类，解决办法：调用方的启动类添加EnableFeignClient注解，并配置扫描包的路径。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@EnableFeignClients(&quot;com.ruipin.*&quot;)</span><br><span class="line">public class DemoApplication &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(DemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>到此，我们的服务间调用就整合完毕了。</p>
]]></content>
      <categories>
        <category>SpringCloud从零开始构建微服务</category>
      </categories>
      <tags>
        <tag>SpringCloud</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud学习 | 第八篇 xxl-job构建定时调度</title>
    <url>/2021/05/31/SpringCloud%E5%AD%A6%E4%B9%A0%EF%BC%88%E5%85%AB%EF%BC%89%20xxl-job%E6%9E%84%E5%BB%BA%E5%AE%9A%E6%97%B6%E8%B0%83%E5%BA%A6/</url>
    <content><![CDATA[<blockquote>
<p>官网地址：[<a href="https://www.xuxueli.com/xxl-job/">https://www.xuxueli.com/xxl-job/</a>]</p>
<p>XXL-JOB是一个分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。</p>
</blockquote>
<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p><a href="%5Bhttps://www.xuxueli.com/xxl-job/%5D(https://www.xuxueli.com/xxl-job/)">中文文档</a></p>
<p>源码仓库地址：</p>
<table>
<thead>
<tr>
<th>仓库地址</th>
<th>Release Download</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://github.com/xuxueli/xxl-job">https://github.com/xuxueli/xxl-job</a></td>
<td><a href="https://github.com/xuxueli/xxl-job/releases">Download</a></td>
</tr>
<tr>
<td><a href="http://gitee.com/xuxueli0323/xxl-job">http://gitee.com/xuxueli0323/xxl-job</a></td>
<td><a href="http://gitee.com/xuxueli0323/xxl-job/releases">Download</a></td>
</tr>
</tbody></table>
<p>Maven依赖Pom</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- http://repo1.maven.org/maven2/com/xuxueli/xxl-job-core/ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;最新稳定版本&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="开始集成"><a href="#开始集成" class="headerlink" title="开始集成"></a>开始集成</h3><h4 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h4><p>我下的2.3.0版本，执行数据库初始化SQL脚本</p>
<p>脚本位置：xuxueli0323-xxl-job-2.3.0\xxl-job\doc\db\tables_xxl_job.sql </p>
<h4 id="导入调度中心与公共依赖模块"><a href="#导入调度中心与公共依赖模块" class="headerlink" title="导入调度中心与公共依赖模块"></a>导入调度中心与公共依赖模块</h4><p>新建一个xxl-job模块，导入下载的源码。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xxl-job-admin：调度中心</span><br><span class="line">xxl-job-core：公共依赖</span><br><span class="line">xxl-job-executor-samples：执行器Sample示例</span><br></pre></td></tr></table></figure>

<p>修改properties配置文件，使用自己的数据库配置，然后启动admin服务，使用账号admin / 123456登录，</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210603172138134.png" alt="image-20210603172138134"></p>
<h4 id="构建自己的Job模块"><a href="#构建自己的Job模块" class="headerlink" title="构建自己的Job模块"></a>构建自己的Job模块</h4><p>新建ruipin-job模块</p>
<p>添加Pom依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- SpringCloud从2020版本后对配置文件加载进行了重构，</span></span><br><span class="line"><span class="comment">        默认不加载bootstrap配置文件，添加bootstrap依赖解决该问题 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 注册中心 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- nacos-config 配置中心依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ruipin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>common-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;ruipin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ruipin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ruipin-demo-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;ruipin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加配置文件</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8120</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ruipin-job</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">http://127.0.0.1:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span>      <span class="comment"># 默认值 properties</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span>      <span class="comment"># 默认值 DEFAULT_GROUP</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line"><span class="attr">xxl:</span></span><br><span class="line">  <span class="attr">job:</span></span><br><span class="line">    <span class="attr">admin:</span></span><br><span class="line">      <span class="attr">addresses:</span> <span class="string">http://127.0.0.1:8080/xxl-job-admin</span></span><br><span class="line">    <span class="attr">executor:</span></span><br><span class="line">      <span class="attr">appname:</span> <span class="string">ruipin-job</span> <span class="comment"># 这个需要在xxl_job_group中添加记录</span></span><br><span class="line">      <span class="attr">address:</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8130</span></span><br><span class="line">      <span class="attr">logpath:</span> <span class="string">/data/applogs/xxl-job/jobhandler</span></span><br><span class="line">      <span class="attr">logretentiondays:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">okhttp:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>添加一个任务组 </p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `xxl_job`.`xxl_job_group`(`id`, `app_name`, `title`, `address_type`, `address_list`, `update_time`) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;ruipin-job&#x27;</span>, <span class="string">&#x27;睿聘执行器&#x27;</span>, <span class="number">0</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;2021-06-04 10:51:14&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>代码编写</p>
<p>XxlJobConfig是demo中的配置</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XxlJobConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(XxlJobConfig.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.admin.addresses&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String adminAddresses;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.accessToken:&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessToken;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.appname&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String appname;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.address&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.ip:&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String ip;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.logpath&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String logPath;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.logretentiondays&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> logRetentionDays;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> XxlJobSpringExecutor <span class="title">xxlJobExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span>);</span><br><span class="line">        XxlJobSpringExecutor xxlJobSpringExecutor = <span class="keyword">new</span> XxlJobSpringExecutor();</span><br><span class="line">        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);</span><br><span class="line">        xxlJobSpringExecutor.setAppname(appname);</span><br><span class="line">        xxlJobSpringExecutor.setAddress(address);</span><br><span class="line">        xxlJobSpringExecutor.setIp(ip);</span><br><span class="line">        xxlJobSpringExecutor.setPort(port);</span><br><span class="line">        xxlJobSpringExecutor.setAccessToken(accessToken);</span><br><span class="line">        xxlJobSpringExecutor.setLogPath(logPath);</span><br><span class="line">        xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> xxlJobSpringExecutor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自己的一个定时任务</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleXxlJob</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DemoFeignClient demoFeignClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1、简单任务示例（Bean模式）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@XxlJob(&quot;ruipinDemoJob&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demoJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        XxlJobHelper.log(<span class="string">&quot;XXL-JOB, Hello World.&quot;</span>);</span><br><span class="line">        Result&lt;String&gt; ruipin = demoFeignClient.sayHello(<span class="string">&quot;ruipin&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;调用结果： &quot;</span> + ruipin);</span><br><span class="line">        XxlJobHelper.log(<span class="string">&quot;CCCCCCCCCCCCCCC&quot;</span> + ruipin.getCode() + <span class="string">&quot; : &quot;</span> + ruipin.getMsg());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@SpringBootApplication(scanBasePackages = &#123;&quot;com.ruipin.app.*&quot;, &quot;com.ruipin.job.*&quot;&#125;)</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">@EnableFeignClients(&quot;com.ruipin.app.*&quot;)</span><br><span class="line">public class JobApplication &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(JobApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210604154804976.png" alt="image-20210604154804976"></p>
<p>配置上面几项即可。操作手动执行一次，就可以看到调度日志中的结果了。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210604154923206.png" alt="image-20210604154923206"></p>
<h3 id="高级用法"><a href="#高级用法" class="headerlink" title="高级用法"></a>高级用法</h3><p>TODO…</p>
]]></content>
      <categories>
        <category>SpringCloud从零开始构建微服务</category>
      </categories>
      <tags>
        <tag>SpringCloud</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud学习 | 第四篇 SpringCloud整合Gateway实现API网关</title>
    <url>/2021/05/14/SpringCloud%E5%AD%A6%E4%B9%A0%EF%BC%88%E5%9B%9B%EF%BC%89%20Gateway%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<blockquote>
<p>接下来继续配置Gateway。</p>
</blockquote>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p><strong>微服务网关的作用有哪些？</strong></p>
<ol>
<li>鉴权。</li>
<li>统一入口，保障服务安全性。</li>
<li>限流熔断统一配置。</li>
<li>路由转发。</li>
<li>负载均衡</li>
<li>链路跟踪。</li>
</ol>
<p><strong>为什么使用Gateway实现API网关？</strong></p>
<p>SpringCloud目前常用的网关有Netflix开源的Zuul和Spring自己的Gateway。</p>
<span id="more"></span>

<h3 id="SpringCloud实现API网关"><a href="#SpringCloud实现API网关" class="headerlink" title="SpringCloud实现API网关"></a>SpringCloud实现API网关</h3><p>本文涉及的微服务模块有：</p>
<table>
<thead>
<tr>
<th>模块</th>
<th>端口</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Nacos Server</td>
<td>8848</td>
<td>注册与配置中心</td>
</tr>
<tr>
<td>ruipin-gateway</td>
<td>9999</td>
<td>网关</td>
</tr>
<tr>
<td>ruipin-auth</td>
<td>8000</td>
<td>认证及服务demo</td>
</tr>
</tbody></table>
<h4 id="新建ruipin-gateway模块"><a href="#新建ruipin-gateway模块" class="headerlink" title="新建ruipin-gateway模块"></a>新建ruipin-gateway模块</h4><h4 id="添加POM依赖"><a href="#添加POM依赖" class="headerlink" title="添加POM依赖"></a>添加POM依赖</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- SpringCloud从2020版本后对配置文件加载进行了重构，</span></span><br><span class="line"><span class="comment">           默认不加载bootstrap配置文件，添加bootstrap依赖解决该问题 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 2020Cloud版本，不加该依赖可能在路由转发时会报503 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 注册中心 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>配置nacos注册和路由转发相关</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9999</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ruipin-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="comment"># 注册中心</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">http://127.0.0.1:8848</span></span><br><span class="line">      <span class="comment"># 配置中心</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">$&#123;spring.cloud.nacos.discovery.server-addr&#125;</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span>  <span class="comment"># 启用动根据服务id生成路由</span></span><br><span class="line">          <span class="attr">lower-case-service-id:</span> <span class="literal">true</span> <span class="comment"># 设置路由的路径为小写的服务ID</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">ruipin-auth</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://ruipin-auth</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/auth/**</span>  <span class="comment"># 所有/auth/**开头的请求都会转发到 lb://ruipin-auth</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span> <span class="comment"># 移除前缀 /auth</span></span><br></pre></td></tr></table></figure>

<h4 id="启动入口"><a href="#启动入口" class="headerlink" title="启动入口"></a>启动入口</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(GatewayApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>依次启动Nacos-server、ruipin-auth、ruipin-gateway。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210514181859300.png" alt="image-20210514181859300"></p>
<p>服务调用9999端口网关服务，/auth/开头的请求转发到了 ruipin-auth下的/sample/hello请求，测试成功。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>到此，一个简单的微服务框架就快要成型了。接下来我们会继续整合OAuth2进行网关鉴权等。</p>
<h3 id="参考连接"><a href="#参考连接" class="headerlink" title="参考连接"></a>参考连接</h3><ul>
<li><p><a href="https://www.cnblogs.com/haoxianrui/p/13608650.html">Spring Cloud实战 | 第四篇：Spring Cloud整合Gateway实现API网关</a></p>
</li>
<li><p><a href="https://www.fangzhipeng.com/springcloud/2021/04/03/sc-2020-gateway.html">SpringCloud 2020版本教程2：使用spring cloud gateway作为服务网关</a></p>
</li>
</ul>
]]></content>
      <categories>
        <category>SpringCloud从零开始构建微服务</category>
      </categories>
      <tags>
        <tag>SpringCloud</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows安装教程之Jekins的安装</title>
    <url>/2021/07/30/Windows%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B%E4%B9%8BJekins%E7%9A%84%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="系统配置"><a href="#系统配置" class="headerlink" title="系统配置"></a>系统配置</h3><p>OS: Windows 10</p>
<p>JDK: 1.8.0_171</p>
<p>Maven: 3.6.3</p>
<h3 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h3><h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><p><a href="https://www.jenkins.io/">官网</a> 下载Jenkins安装包。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210730104534113.png" alt="image-20210730104534113"></p>
<h4 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h4><p>一路傻瓜安装即可。</p>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><p>这里直接使用命令启动。管理员权限打开cmd或Power Shell。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java -jar jenkins.war --httpPort=8080</span><br></pre></td></tr></table></figure>

<p>启动Jenkins服务。看到如下信息表示启动成功。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210730104830318.png" alt="image-20210730104830318"></p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2>]]></content>
      <categories>
        <category>软件安装</category>
      </categories>
      <tags>
        <tag>Windows, jekins</tag>
      </tags>
  </entry>
  <entry>
    <title>Jekins配置与项目构建</title>
    <url>/2021/08/12/Jekins%E9%85%8D%E7%BD%AE%E4%B8%8E%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA/</url>
    <content><![CDATA[<h2 id="配置Git"><a href="#配置Git" class="headerlink" title="配置Git"></a>配置Git</h2><p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210812144931741.png" alt="image-20210812144931741"></p>
<h2 id="配置JDK"><a href="#配置JDK" class="headerlink" title="配置JDK"></a>配置JDK</h2><p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210812145310634.png" alt="image-20210812145310634"></p>
<h2 id="配置maven"><a href="#配置maven" class="headerlink" title="配置maven"></a>配置maven</h2><p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210812145516379.png" alt="image-20210812145516379"></p>
<p>到这里，我们就已经可以正常构建了。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210812150551294.png" alt="image-20210812150551294"></p>
<p>接下来我们先把包发布到服务器。</p>
]]></content>
      <categories>
        <category>软件安装</category>
      </categories>
      <tags>
        <tag>Windows, jekins</tag>
      </tags>
  </entry>
  <entry>
    <title>Maven常用命令</title>
    <url>/2021/06/03/Maven%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<h3 id="如何添加本地jar包到maven仓库"><a href="#如何添加本地jar包到maven仓库" class="headerlink" title="如何添加本地jar包到maven仓库"></a>如何添加本地jar包到maven仓库</h3><p>安装指定文件到本地仓库命令：mvn install:install-file</p>
<p><strong>cmd打开命令行，不要用powerShell</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-DgroupId=&lt;groupId&gt;       : 设置项目代码的包名(一般用组织名)</span><br><span class="line">-DartifactId=&lt;artifactId&gt; : 设置项目名或模块名 </span><br><span class="line">-Dversion=1.0.0           : 版本号</span><br><span class="line">-Dpackaging=jar           : 什么类型的文件(jar包)</span><br><span class="line">-Dfile=&lt;myfile.jar&gt;       : 指定jar文件路径与文件名(同目录只需文件名)</span><br><span class="line">安装命令实例：</span><br><span class="line">mvn install:install-file -DgroupId=io.netty -DartifactId=netty-all -Dversion=4.1.58.Final -Dpackaging=jar -Dfile=D:\netty-all-4.1.58.Final.jar</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210603164713209.png" alt="image-20210603164713209"></p>
]]></content>
      <tags>
        <tag>Maven</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo（一）:使用hexo + next主题搭建个人博客</title>
    <url>/2021/05/10/hexo%EF%BC%88%E4%B8%80%EF%BC%89%E4%BD%BF%E7%94%A8hexo%E5%92%8Cnext%E4%B8%BB%E9%A2%98%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/</url>
    <content><![CDATA[<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><h4 id="安装nodejs"><a href="#安装nodejs" class="headerlink" title="安装nodejs"></a>安装nodejs</h4><p>  从<a href="https://nodejs.org/en/download/">官网</a>下载最新的安装版本。Windows Installer (.msi) 64-bit</p>
<p>  这里也可以从<a href="https://npm.taobao.org/">淘宝镜像</a>去下载。</p>
<p>  一路默认下一步安装。</p>
<h4 id="安装Hexo"><a href="#安装Hexo" class="headerlink" title="安装Hexo"></a>安装Hexo</h4><p> <code>npm install -g hexo</code>全局安装hexo。</p>
<p> 报错信息：</p>
<p> Q：<code>npm WARN deprecated titlecase@1.1.2: no longer maintained</code></p>
<p> A：<code>npm -v</code>查看npm版本，<code>npm install -g npm </code>更新版本即可。</p>
<span id="more"></span>

<h4 id="准备github帐号"><a href="#准备github帐号" class="headerlink" title="准备github帐号"></a>准备github帐号</h4><p>注册github帐号</p>
<p>新建一个repository，名称为 <code>yourname.github.io</code>，我的帐号名为<code>e***u</code>，故我的repository为<code>e***u.github.io</code>。</p>
<h4 id="安装git"><a href="#安装git" class="headerlink" title="安装git."></a>安装git.</h4><p> 从<a href="https://git-scm.com/download/win">官网</a>选择64位下载。</p>
<p> 一路默认下一步安装。</p>
<h3 id="创建本地博客"><a href="#创建本地博客" class="headerlink" title="创建本地博客"></a>创建本地博客</h3><h4 id="环境检测"><a href="#环境检测" class="headerlink" title="环境检测"></a>环境检测</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">node -v // 检测node是否正常安装</span><br><span class="line">hexo -v // 检测hexo是否正常安装</span><br><span class="line">npm -v  // 检测npm 是否正常安装</span><br><span class="line">git --version //检测git版本</span><br></pre></td></tr></table></figure>

<h4 id="初始化项目"><a href="#初始化项目" class="headerlink" title="初始化项目"></a>初始化项目</h4>   <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\Eden\gitee-blog&gt; hexo init 2021-blog</span><br></pre></td></tr></table></figure>
<p>   执行命令时，报”无法加载文件 C:\Users\ci22578\AppData\Roaming\npm\hexo.ps1，因为在此系统上禁止运行脚本。“。</p>
<p>   以管理员身份运行 powershell, 并执行 set-ExecutionPolicy RemoteSigned 命令，将计算机上的执行策略更改为 RemoteSigned，即可。</p>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\Eden\gitee-blog\2021-blog&gt; hexo s [-p 端口号]  //启动，默认端口4000</span><br></pre></td></tr></table></figure>

<h4 id="修改博客基本信息"><a href="#修改博客基本信息" class="headerlink" title="修改博客基本信息"></a>修改博客基本信息</h4><pre><code>修改博客根目录下的_config.yml文件，后面称站点配置。
</code></pre>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> # Site 博客主配置信息</span><br><span class="line">title: Hexo                             # 博客名称</span><br><span class="line">subtitle: &#x27;一条瞎扑腾的咸鱼&#x27;            # 博客子标题</span><br><span class="line">description: &#x27;一条瞎扑腾的咸鱼&#x27;         # 作者描述</span><br><span class="line">keywords:                               # 站点关键字，用于搜索优化</span><br><span class="line">author: Eden 懒散老马                   # 博主名</span><br><span class="line">language: zh-CN                         # 站点语言</span><br><span class="line">timezone: &#x27;Asia/Shanghai&#x27;               # 时区	 </span><br></pre></td></tr></table></figure>

<h3 id="配置next主题"><a href="#配置next主题" class="headerlink" title="配置next主题"></a>配置next主题</h3><h4 id="下载next主题。"><a href="#下载next主题。" class="headerlink" title="下载next主题。"></a>下载next主题。</h4><p>  git clone <a href="https://github.com/theme-next/hexo-theme-next">https://github.com/theme-next/hexo-theme-next</a> themes/next</p>
<p>  访问不了也可以在gitee上搜索别人同步过来的。</p>
<p>  如果在博客根目录按上面命令下载，则直接跳过。如果是在其他目录下载，则将下载文件夹更名为next，拖放到博客目录中themes目录下。</p>
<h4 id="应用next主题"><a href="#应用next主题" class="headerlink" title="应用next主题"></a>应用next主题</h4><pre><code>修改站点配置（2021-blog\_config.yml)。
</code></pre>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> # Extensions 扩展信息配置</span><br><span class="line">theme: next	                            # 主题设置为我们的next主题，默认是landscape</span><br></pre></td></tr></table></figure>
<h3 id="next扩展配置。"><a href="#next扩展配置。" class="headerlink" title="next扩展配置。"></a>next扩展配置。</h3><h4 id="主题样式配置"><a href="#主题样式配置" class="headerlink" title="主题样式配置"></a>主题样式配置</h4><pre><code>修改主题目录下的_config.yml配置
</code></pre>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># ---------------------------------------------------------------</span><br><span class="line"># Menu Settings 菜单设置</span><br><span class="line"># ---------------------------------------------------------------</span><br><span class="line">menu:</span><br><span class="line">home: / || fa fa-home</span><br><span class="line">#about: /about/ || fa fa-user</span><br><span class="line">tags: /tags/ || fa fa-tags</span><br><span class="line">categories: /categories/ || fa fa-th</span><br><span class="line">archives: /archives/ || fa fa-archive</span><br><span class="line">#schedule: /schedule/ || fa fa-calendar</span><br><span class="line">#sitemap: /sitemap.xml || fa fa-sitemap</span><br><span class="line">#commonweal: /404/ || fa fa-heartbeat</span><br><span class="line"></span><br><span class="line"># ---------------------------------------------------------------</span><br><span class="line"># Scheme Settings 样式设置</span><br><span class="line"># --------------------------------------------------------------- </span><br><span class="line"># Schemes</span><br><span class="line">#scheme: Muse</span><br><span class="line">#scheme: Mist</span><br><span class="line">scheme: Pisces </span><br><span class="line">#scheme: Gemini</span><br><span class="line"></span><br><span class="line"># Dark Mode</span><br><span class="line">darkmode: false</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="隐藏底部next-强力驱动字样。"><a href="#隐藏底部next-强力驱动字样。" class="headerlink" title="隐藏底部next / 强力驱动字样。"></a>隐藏底部next / 强力驱动字样。</h4><p>  themes\next\layout_partials目录中找到footer.njk（不同版本的文件扩展名可能不同）</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">用 &lt;!-- --!&gt; 包住下面这段代码 或 直接删除</span><br><span class="line">&lt;!--</span><br><span class="line">&#123;%- if theme.footer.powered %&#125;</span><br><span class="line">  &lt;div class=&quot;powered-by&quot;&gt;</span><br><span class="line">	&#123;%- set next_site = &#x27;https://theme-next.js.org&#x27; if theme.scheme === &#x27;Gemini&#x27; else &#x27;https://theme-next.js.org/&#x27; + theme.scheme | lower + &#x27;/&#x27; %&#125;</span><br><span class="line">	&#123;&#123;- __(&#x27;footer.powered&#x27;, next_url(&#x27;https://hexo.io&#x27;, &#x27;Hexo&#x27;, &#123;class: &#x27;theme-link&#x27;&#125;) + &#x27; &amp; &#x27; + next_url(next_site, &#x27;NexT.&#x27; + theme.scheme, &#123;class: &#x27;theme-link&#x27;&#125;)) &#125;&#125;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&#123;%- endif %&#125;</span><br><span class="line">--!&gt;</span><br></pre></td></tr></table></figure>
<h4 id="Local-Search-本地搜索"><a href="#Local-Search-本地搜索" class="headerlink" title="Local Search 本地搜索"></a>Local Search 本地搜索</h4><p>  安装插件 hexo-generator-searchdb</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install hexo-generator-searchdb --save</span><br></pre></td></tr></table></figure>
<p>  修改根目录_config.yml，添加下面配置到文件末尾。</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">search:</span><br><span class="line">  path: search.xml</span><br><span class="line">  field: post</span><br><span class="line">  format: html</span><br><span class="line">  limit: 10000</span><br></pre></td></tr></table></figure>
<p>  修改主题配置_config.yml,启用本地搜索</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Local Search</span><br><span class="line"># Dependencies: https://github.com/next-theme/hexo-generator-searchdb</span><br><span class="line">local_search:</span><br><span class="line">  enable: true</span><br></pre></td></tr></table></figure>
<h4 id="设置网站图标"><a href="#设置网站图标" class="headerlink" title="设置网站图标"></a>设置网站图标</h4><p>  去easyicon找个图标</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">favicon:</span><br><span class="line">  small: /images/favicon_48px.ico</span><br><span class="line">  medium: /images/favicon_48px.ico</span><br><span class="line">  apple_touch_icon: /images/apple-touch-icon-next.png</span><br><span class="line">  safari_pinned_tab: /images/logo.svg</span><br></pre></td></tr></table></figure>
<h4 id="增加文章字数统计和阅读时长"><a href="#增加文章字数统计和阅读时长" class="headerlink" title="增加文章字数统计和阅读时长"></a>增加文章字数统计和阅读时长</h4><p>  Dependencies: <a href="https://github.com/next-theme/hexo-word-counter">https://github.com/next-theme/hexo-word-counter</a> 目前设置没有生效，后续跟踪查看。</p>
<h4 id="博客加妹子"><a href="#博客加妹子" class="headerlink" title="博客加妹子"></a>博客加妹子</h4><p>  npm install -save hexo-helper-live2d</p>
<p>  修改站点配置文件</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">live2d:</span><br><span class="line">  enable: true</span><br><span class="line">  scriptFrom: local</span><br><span class="line">  pluginRootPath: live2dw/</span><br><span class="line">  pluginJsPath: lib/</span><br><span class="line">  pluginModelPath: assets/</span><br><span class="line">  tagMode: false</span><br><span class="line">  log: false</span><br><span class="line">  model:</span><br><span class="line">	use: live2d-widget-model-shizuku</span><br><span class="line">  display:</span><br><span class="line">    position: right</span><br><span class="line">    width: 150</span><br><span class="line">    height: 300</span><br><span class="line">  mobile:</span><br><span class="line">    show: true</span><br></pre></td></tr></table></figure>
<p>  安装模型，在命令行运行命令：npm install –save live2d-widget-model-shizuku</p>
<pre><code>可选模型：

live2d-widget-model-chitose

live2d-widget-model-epsilon2_1

live2d-widget-model-gf

live2d-widget-model-haru/01 (use npm install --save live2d-widget-model-haru)

live2d-widget-model-haru/02 (use npm install --save live2d-widget-model-haru)

live2d-widget-model-haruto

live2d-widget-model-hibiki

live2d-widget-model-hijiki

live2d-widget-model-izumi

live2d-widget-model-koharu

live2d-widget-model-miku

live2d-widget-model-ni-j

live2d-widget-model-nico

live2d-widget-model-nietzsche

live2d-widget-model-nipsilon

live2d-widget-model-nito

live2d-widget-model-shizuku

live2d-widget-model-tororo

live2d-widget-model-tsumiki

live2d-widget-model-unitychan

live2d-widget-model-wanko

live2d-widget-model-z16
</code></pre>
<h4 id="代码复制"><a href="#代码复制" class="headerlink" title="代码复制"></a>代码复制</h4><pre><code><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">codeblock:</span><br><span class="line">	border_radius: 8   # 按钮圆滑度</span><br><span class="line">	copy_button:  # 设置是否开启代码块复制按钮</span><br><span class="line">		enable: true</span><br><span class="line">		show_result: true  # 是否显示复制成功信息</span><br></pre></td></tr></table></figure>
</code></pre>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>  本文我们从零开始搭建个人本地hexo博客，并使用next主题。后续我们尝试将hexo博客推送至github、gitee等站点。生成我们的博客站。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul>
<li><a href="https://blog.csdn.net/as480133937/article/details/100138838/">Hexo-Next 主题博客个性化配置超详细，超全面</a></li>
</ul>
]]></content>
      <categories>
        <category>使用hexo搭建博客</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo（二）:将博客推送至github</title>
    <url>/2021/05/11/hexo%EF%BC%88%E4%BA%8C%EF%BC%89%E5%B0%86%E5%8D%9A%E5%AE%A2%E6%8E%A8%E9%80%81%E5%88%B0github/</url>
    <content><![CDATA[<h3 id="操作步骤。"><a href="#操作步骤。" class="headerlink" title="操作步骤。"></a>操作步骤。</h3><p> 登录github，并创建public仓库。</p>
<p> 仓库名命名格式：如果帐号名为<code>jack</code>，则repository为<code>jack.github.io</code></p>
<h3 id="安装deploy扩展"><a href="#安装deploy扩展" class="headerlink" title="安装deploy扩展"></a>安装deploy扩展</h3><p>在跟目录(2021-blog)内，执行<code>npm install hexo-deployer-git --save</code> 安装部署的扩展。</p>
<h3 id="修改站点配置"><a href="#修改站点配置" class="headerlink" title="修改站点配置"></a>修改站点配置</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repo: git@github.com:jack/jack.github.io.git</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h3 id="推送"><a href="#推送" class="headerlink" title="推送"></a>推送</h3><p> 根目录下使用 hexo d -g 即可将项目推送至github远程仓库。</p>
<p> 快使用jack.github.io看看能不能访问了？</p>
<h3 id="github添加免密"><a href="#github添加免密" class="headerlink" title="github添加免密"></a>github添加免密</h3><p> 本地生成ssh秘钥文件</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 检查是否存在</span><br><span class="line">cd ~/.ssh</span><br><span class="line">ls</span><br><span class="line">// 生成密钥，一路回车即可</span><br><span class="line">ssh-keygen -t rsa -C “m***n_11@126.com” </span><br></pre></td></tr></table></figure>
<p> github网站，头像-&gt; settings-&gt; SSH and GPG keys -&gt; New SSh Key </p>
<p> 将电脑上C:\Users.ssh 中的id_rsa.pub中的内容 复制到key中，title自定义即可。</p>
<p> 添加完毕后，本地命令行 输入 ssh -T <a href="mailto:&#103;&#105;&#116;&#64;&#x67;&#x69;&#116;&#104;&#x75;&#x62;&#46;&#x63;&#111;&#x6d;">&#103;&#105;&#116;&#64;&#x67;&#x69;&#116;&#104;&#x75;&#x62;&#46;&#x63;&#111;&#x6d;</a> 测试下链接，当看到</p>
<p> <code>Hi jack! You&#39;ve successfully authenticated, but GitHub does not provide shell access.</code></p>
<p> 说明配置成功，再推送就可以免密推送了。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>  我最终配置没有成功，发现我本地deploy文件里的配置是https的，因为免密是ssh的，所以地址一定要使用<a href="mailto:&#x67;&#105;&#x74;&#64;&#x67;&#105;&#x74;&#x68;&#117;&#98;&#46;&#99;&#x6f;&#x6d;">&#x67;&#105;&#x74;&#64;&#x67;&#105;&#x74;&#x68;&#117;&#98;&#46;&#99;&#x6f;&#x6d;</a>:jack/jack.github.io.git这种。</p>
<pre><code>修改后推送成功。
</code></pre>
]]></content>
      <categories>
        <category>使用hexo搭建博客</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>微信公众号开发之准备工作</title>
    <url>/2021/09/01/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%80)%20%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C/</url>
    <content><![CDATA[<h2 id="申请测试公众号"><a href="#申请测试公众号" class="headerlink" title="申请测试公众号"></a>申请测试公众号</h2><p> 在微信官网申请测试公众号。<a href="https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Requesting_an_API_Test_Account.html">申请地址</a></p>
<p> <img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210901141022560.png" alt="image-20210901141022560"></p>
<p> 下一步 </p>
<span id="more"></span>

<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210901141042031.png" alt="image-20210901141042031"></p>
<p> 扫码同意后就申请成功了</p>
<p> <img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210901141129927.png" alt="image-20210901141129927"></p>
<h2 id="构建一个web应用"><a href="#构建一个web应用" class="headerlink" title="构建一个web应用"></a>构建一个web应用</h2><p><a href="https://gitee.com/ruocy/java_demo/tree/master/boot-wechat">demo地址</a></p>
<p>pom依赖</p>
<p>主要依赖：</p>
<table>
<thead>
<tr>
<th>依赖包</th>
<th>版本</th>
</tr>
</thead>
<tbody><tr>
<td>spring-boot-starter-parent</td>
<td>2.5.4</td>
</tr>
<tr>
<td>spring-boot-starter-web</td>
<td></td>
</tr>
<tr>
<td>lombok</td>
<td></td>
</tr>
<tr>
<td>weixin-java-mp</td>
<td>4.1.0</td>
</tr>
</tbody></table>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.eden.wechat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>boot-wechat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>boot-wechat<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>微信公众号开发demo项目<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">weixin-java-mp.version</span>&gt;</span>4.1.0<span class="tag">&lt;/<span class="name">weixin-java-mp.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.binarywang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>weixin-java-mp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;weixin-java-mp.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>resource配置</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">wx:</span></span><br><span class="line">  <span class="attr">mp:</span></span><br><span class="line">    <span class="attr">configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">appId:</span> <span class="string">wxc0e******c085</span></span><br><span class="line">        <span class="attr">secret:</span> <span class="string">ee20******bfca6</span></span><br><span class="line">        <span class="attr">token:</span> <span class="string">*******</span></span><br><span class="line">        <span class="attr">aesKey:</span> <span class="string">*******</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<p>加载appid的配置类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;wx.mp&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxMpProperties</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否使用redis存储access token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> useRedis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * redis 配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> RedisConfig redisConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * redis服务器 主机地址</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String host;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * redis服务器 端口号</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> Integer port;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * redis服务器 密码</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 多个公众号配置信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;MpConfig&gt; configs;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MpConfig</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置微信公众号的appid</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String appId;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置微信公众号的app secret</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String secret;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置微信公众号的token</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String token;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置微信公众号的EncodingAESKey</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String aesKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Gson gson = <span class="keyword">new</span> GsonBuilder()</span><br><span class="line">                .setPrettyPrinting()</span><br><span class="line">                .disableHtmlEscaping()</span><br><span class="line">                .create();</span><br><span class="line">        <span class="keyword">return</span> gson.toJson(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>读取appid配置</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(WxMpProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxMpConfiguration</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WxMpProperties properties;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WxMpService <span class="title">wxMpService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 代码里 getConfigs()处报错的同学，请注意仔细阅读项目说明，你的IDE需要引入lombok插件！！！！</span></span><br><span class="line">        <span class="keyword">final</span> List&lt;WxMpProperties.MpConfig&gt; configs = <span class="keyword">this</span>.properties.getConfigs();</span><br><span class="line">        <span class="keyword">if</span> (configs == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;大哥，拜托先看下项目首页的说明（readme文件），添加下相关配置，注意别配错了！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        WxMpService service = <span class="keyword">new</span> WxMpServiceImpl();</span><br><span class="line">        service.setMultiConfigStorages(configs</span><br><span class="line">                .stream().map(a -&gt; &#123;</span><br><span class="line">                    WxMpDefaultConfigImpl configStorage = <span class="keyword">new</span> WxMpDefaultConfigImpl();</span><br><span class="line">                    <span class="comment">// 项目暂不考虑redis</span></span><br><span class="line">                  <span class="comment">/*  if (this.properties.isUseRedis()) &#123;</span></span><br><span class="line"><span class="comment">                        final WxMpProperties.RedisConfig redisConfig = this.properties.getRedisConfig();</span></span><br><span class="line"><span class="comment">                        JedisPoolConfig poolConfig = new JedisPoolConfig();</span></span><br><span class="line"><span class="comment">                        JedisPool jedisPool = new JedisPool(poolConfig, redisConfig.getHost(), redisConfig.getPort(),</span></span><br><span class="line"><span class="comment">                                -1, redisConfig.getPassword());</span></span><br><span class="line"><span class="comment">                        configStorage = new WxMpRedisConfigImpl(new JedisWxRedisOps(jedisPool), a.getAppId());</span></span><br><span class="line"><span class="comment">                    &#125; else &#123;</span></span><br><span class="line"><span class="comment">                        configStorage = new WxMpDefaultConfigImpl();</span></span><br><span class="line"><span class="comment">                    &#125;*/</span></span><br><span class="line"></span><br><span class="line">                    configStorage.setAppId(a.getAppId());</span><br><span class="line">                    configStorage.setSecret(a.getSecret());</span><br><span class="line">                    configStorage.setToken(a.getToken());</span><br><span class="line">                    configStorage.setAesKey(a.getAesKey());</span><br><span class="line">                    <span class="keyword">return</span> configStorage;</span><br><span class="line">                &#125;).collect(Collectors.toMap(WxMpDefaultConfigImpl::getAppId, a -&gt; a, (o, n) -&gt; o)));</span><br><span class="line">        <span class="keyword">return</span> service;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WxMpMessageRouter <span class="title">messageRouter</span><span class="params">(WxMpService wxMpService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> WxMpMessageRouter newRouter = <span class="keyword">new</span> WxMpMessageRouter(wxMpService);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*// 记录所有事件的日志 （异步执行）</span></span><br><span class="line"><span class="comment">        newRouter.rule().handler(this.logHandler).next();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        // 接收客服会话管理事件</span></span><br><span class="line"><span class="comment">        newRouter.rule().async(false).msgType(EVENT).event(KF_CREATE_SESSION)</span></span><br><span class="line"><span class="comment">                .handler(this.kfSessionHandler).end();</span></span><br><span class="line"><span class="comment">        newRouter.rule().async(false).msgType(EVENT).event(KF_CLOSE_SESSION)</span></span><br><span class="line"><span class="comment">                .handler(this.kfSessionHandler).end();</span></span><br><span class="line"><span class="comment">        newRouter.rule().async(false).msgType(EVENT).event(KF_SWITCH_SESSION)</span></span><br><span class="line"><span class="comment">                .handler(this.kfSessionHandler).end();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        // 门店审核事件</span></span><br><span class="line"><span class="comment">        newRouter.rule().async(false).msgType(EVENT).event(POI_CHECK_NOTIFY).handler(this.storeCheckNotifyHandler).end();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        // 自定义菜单事件</span></span><br><span class="line"><span class="comment">        newRouter.rule().async(false).msgType(EVENT).event(WxConsts.EventType.CLICK).handler(this.menuHandler).end();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        // 点击菜单连接事件</span></span><br><span class="line"><span class="comment">        newRouter.rule().async(false).msgType(EVENT).event(WxConsts.EventType.VIEW).handler(this.nullHandler).end();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        // 关注事件</span></span><br><span class="line"><span class="comment">        newRouter.rule().async(false).msgType(EVENT).event(SUBSCRIBE).handler(this.subscribeHandler).end();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        // 取消关注事件</span></span><br><span class="line"><span class="comment">        newRouter.rule().async(false).msgType(EVENT).event(UNSUBSCRIBE).handler(this.unsubscribeHandler).end();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        // 上报地理位置事件</span></span><br><span class="line"><span class="comment">        newRouter.rule().async(false).msgType(EVENT).event(WxConsts.EventType.LOCATION).handler(this.locationHandler).end();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        // 接收地理位置消息</span></span><br><span class="line"><span class="comment">        newRouter.rule().async(false).msgType(WxConsts.XmlMsgType.LOCATION).handler(this.locationHandler).end();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        // 扫码事件</span></span><br><span class="line"><span class="comment">        newRouter.rule().async(false).msgType(EVENT).event(WxConsts.EventType.SCAN).handler(this.scanHandler).end();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        // 默认</span></span><br><span class="line"><span class="comment">        newRouter.rule().async(false).handler(this.msgHandler).end();*/</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> newRouter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>接入的服务器认证</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/wx/portal/&#123;appid&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxPortalController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WxMpService wxMpService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WxMpMessageRouter messageRouter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(produces = &quot;text/plain;charset=utf-8&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">authGet</span><span class="params">(<span class="meta">@PathVariable</span> String appid, </span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="meta">@RequestParam(name = &quot;signature&quot;, required = false)</span> String signature, </span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="meta">@RequestParam(name = &quot;timestamp&quot;, required = false)</span> String timestamp, </span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="meta">@RequestParam(name = &quot;nonce&quot;, required = false)</span> String nonce, </span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="meta">@RequestParam(name = &quot;echostr&quot;, required = false)</span> String echostr)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;\n接收微信认证消息:[&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;]&quot;</span>, signature, timestamp, nonce, echostr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isAnyBlank(signature, timestamp, nonce, echostr)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;请求参数非法，请核实&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.wxMpService.switchover(appid)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(<span class="string">&quot;未找到对应appid=[%s]的配置，请核实&quot;</span>, appid));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (wxMpService.checkSignature(timestamp, nonce, signature)) &#123;</span><br><span class="line">            <span class="keyword">return</span> echostr;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;非法请求&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在可以把服务打包部署到服务器上。服务需要使用80端口</p>
<p>启动成功，因为我这边80端口被nginx占用，所以这里使用8081，nginx进行端口转发。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210901174056625.png" alt="image-20210901174056625"></p>
<p>接下来我们开始认证服务。登录<a href="https://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&t=sandbox/index">公众平台</a>修改服务器的地址</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210901174329226.png" alt="image-20210901174329226"></p>
<p>看到配置成功，说明我们的服务与微信服务认证通过了。</p>
<p>后面我们将做关注及消息的发送。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://gitee.com/binary/weixin-java-mp-demo-springboot">班纳睿-基于Spring Boot 和 WxJava 实现的微信公众号Java后端Demo，支持多公众号</a></li>
</ul>
]]></content>
      <categories>
        <category>微信公众号开发</category>
      </categories>
      <tags>
        <tag>公众号</tag>
      </tags>
  </entry>
  <entry>
    <title>微信公众号开发之定义菜单</title>
    <url>/2021/09/03/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%89)%20%E5%AE%9A%E4%B9%89%E8%8F%9C%E5%8D%95/</url>
    <content><![CDATA[<blockquote>
<p>上文我们已经搭建好了一个后端服务也可以监听关注事件，班纳睿老师也在demo里设置了其他的所有消息及事件的处理方法，直接照搬就好了。感谢班大大！接下来继续学习下自定义菜单的设置。</p>
</blockquote>
<h2 id="界面操作设置菜单"><a href="#界面操作设置菜单" class="headerlink" title="界面操作设置菜单"></a>界面操作设置菜单</h2><p>因为测试的公众号没有界面操作这里需要申请一个个人公众号。假定你已经会申请了，如果不会操作可以参照结尾连接。</p>
<p>进入，<a href="https://mp.weixin.qq.com/">公众号开发平台</a>，登录自己申请的个人公众号(订阅号)，点击左侧 内容与互动 -&gt; 自定义菜单即可。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210903115639500.png" alt="image-20210903115639500"></p>
<p>我这里停用了这个菜单配置功能，还需要先去启用。进入 设置与开发 -&gt; 基本配置，关闭服务器配置。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210903115856691.png" alt="image-20210903115856691"></p>
<p>再进入自定义菜单。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210903115946552.png" alt="image-20210903115946552"></p>
<p>可以开始设置了。</p>
<h2 id="接口设置菜单"><a href="#接口设置菜单" class="headerlink" title="接口设置菜单"></a>接口设置菜单</h2><p>界面设置的公众号菜单只能发布文章、图片、音频、视频等。不能自定义页面。所以我们要配置自定义的菜单及H5地址。</p>
<p><a href="https://developers.weixin.qq.com/doc/offiaccount/Custom_Menus/Creating_Custom-Defined_Menu.html">文档-自定义菜单</a></p>
<p><a href="https://gitee.com/ruocy/java_demo/tree/master/boot-wechat">代码地址</a></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><p><a href="https://kf.qq.com/faq/120911VrYVrA151009eIrYvy.html">(个人)注册公众平台步骤</a></p>
</li>
<li><p><a href="https://gitee.com/binary/weixin-java-mp-demo-springboot">班纳睿-基于Spring Boot 和 WxJava 实现的微信公众号Java后端Demo，支持多公众号</a></p>
</li>
</ul>
]]></content>
      <categories>
        <category>微信公众号开发</category>
      </categories>
      <tags>
        <tag>公众号</tag>
      </tags>
  </entry>
  <entry>
    <title>微信公众号开发之事件监听</title>
    <url>/2021/09/02/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%8C)%20%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC/</url>
    <content><![CDATA[<blockquote>
<p>上文我们已经搭建好了一个后端服务，并且可以和微信服务正常认证了，接下来我们尝试着监听关注、取消关注等事件并尝试被动、主动回复粉丝消息等。</p>
</blockquote>
<h2 id="接收事件推送"><a href="#接收事件推送" class="headerlink" title="接收事件推送"></a>接收事件推送</h2><h3 id="数据传输方式"><a href="#数据传输方式" class="headerlink" title="数据传输方式"></a>数据传输方式</h3><p><a href="https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Receiving_event_pushes.html">文档地址</a></p>
<p>用户在关注与取消关注公众号时，微信会把这个事件推送到开发者填写的URL。</p>
<p>参数的推送格式大致如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">我配置的URL: http://114.115.147.234/wx/portal/wxc......5</span><br><span class="line">URL: /wx/portal/wxc..........5?signature=930593db8&amp;timestamp=1630568875&amp;nonce=12892</span><br><span class="line">数据：</span><br><span class="line">&lt;xml&gt;</span><br><span class="line">    &lt;ToUserName&gt;&lt;![CDATA[gh_1....5]]&gt;&lt;/ToUserName&gt;</span><br><span class="line">    &lt;FromUserName&gt;&lt;![CDATA[oFiT_wc.....sGHU]]&gt;&lt;/FromUserName&gt;</span><br><span class="line">    &lt;CreateTime&gt;1630568875&lt;/CreateTime&gt;</span><br><span class="line">    &lt;MsgType&gt;&lt;![CDATA[event]]&gt;&lt;/MsgType&gt;</span><br><span class="line">    &lt;Event&gt;&lt;![CDATA[subscribe]]&gt;&lt;/Event&gt;</span><br><span class="line">    &lt;EventKey&gt;&lt;![CDATA[]]&gt;&lt;/EventKey&gt;</span><br><span class="line">&lt;/xml&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<p>URL会把认证的参数和加解密信息以param的形式在url上提交，数据以xml的形式传递。</p>
<h3 id="代码编写"><a href="#代码编写" class="headerlink" title="代码编写"></a>代码编写</h3><p>前文我们在WxMpConfiguration中的messageRouter的代码注释掉了，现在我们放开关注事件代码。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SubscribeHandler subscribeHandler;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> WxMpMessageRouter <span class="title">messageRouter</span><span class="params">(WxMpService wxMpService)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> WxMpMessageRouter newRouter = <span class="keyword">new</span> WxMpMessageRouter(wxMpService);</span><br><span class="line">    <span class="comment">// 关注事件</span></span><br><span class="line">    newRouter.rule()			<span class="comment">//开启一个新的route规则</span></span><br><span class="line">             .async(<span class="keyword">false</span>)		<span class="comment">//设置是否同步</span></span><br><span class="line">             .msgType(EVENT)	<span class="comment">//route规则处理的消息类型</span></span><br><span class="line">             .event(SUBSCRIBE)、<span class="comment">//event类型</span></span><br><span class="line">             .handler(<span class="keyword">this</span>.subscribeHandler)<span class="comment">//具体的处理类</span></span><br><span class="line">             .end();		   <span class="comment">//规则结束，添加进router的rules集合</span></span><br><span class="line">    <span class="keyword">return</span> newRouter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SubscribeHandler关注事件处理类和父类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractHandler</span> <span class="keyword">implements</span> <span class="title">WxMpMessageHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubscribeHandler</span> <span class="keyword">extends</span> <span class="title">AbstractHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WxMpXmlOutMessage <span class="title">handle</span><span class="params">(WxMpXmlMessage wxMessage,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    Map&lt;String, Object&gt; context, WxMpService weixinService,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    WxSessionManager sessionManager)</span> <span class="keyword">throws</span> WxErrorException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.logger.info(<span class="string">&quot;新关注用户 OPENID: &quot;</span> + wxMessage.getFromUser());</span><br><span class="line">        String nickName = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">        <span class="comment">// 获取微信用户基本信息</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            WxMpUser userWxInfo = weixinService.getUserService()</span><br><span class="line">                .userInfo(wxMessage.getFromUser(), <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (userWxInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                nickName = userWxInfo.getNickname();</span><br><span class="line">                <span class="comment">// TODO 可以添加关注用户到本地数据库</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (WxErrorException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e.getError().getErrorCode() == <span class="number">48001</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.logger.info(<span class="string">&quot;该公众号没有获取用户信息权限！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        WxMpXmlOutMessage responseResult = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            responseResult = <span class="keyword">this</span>.handleSpecial(wxMessage);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">this</span>.logger.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (responseResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> responseResult;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> TextBuilder().build(String.format(<span class="string">&quot;%s,感谢关注&quot;</span>, nickName), wxMessage, weixinService);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">this</span>.logger.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理特殊请求，比如如果是扫码进来的，可以做相应处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> WxMpXmlOutMessage <span class="title">handleSpecial</span><span class="params">(WxMpXmlMessage wxMessage)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//TODO</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加消息构建类TextBuilder和AbstractBuilder</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractBuilder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> WxMpXmlOutMessage <span class="title">build</span><span class="params">(String content,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            WxMpXmlMessage wxMessage, WxMpService service)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TextBuilder</span> <span class="keyword">extends</span> <span class="title">AbstractBuilder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WxMpXmlOutMessage <span class="title">build</span><span class="params">(String content, WxMpXmlMessage wxMessage,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   WxMpService service)</span> </span>&#123;</span><br><span class="line">        WxMpXmlOutTextMessage m = WxMpXmlOutMessage.TEXT().content(content)</span><br><span class="line">            .fromUser(wxMessage.getToUser()).toUser(wxMessage.getFromUser())</span><br><span class="line">            .build();</span><br><span class="line">        <span class="keyword">return</span> m;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基础工作都做完了，现在我们在WxPortalController处理微信的关注事件。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// application/xml表示微信提交的xml数据，requestBody接收xml数据</span></span><br><span class="line"><span class="meta">@PostMapping(produces = &quot;application/xml; charset=UTF-8&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">post</span><span class="params">(<span class="meta">@PathVariable</span> String appid,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="meta">@RequestBody</span> String requestBody,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="meta">@RequestParam(&quot;signature&quot;)</span> String signature,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="meta">@RequestParam(&quot;timestamp&quot;)</span> String timestamp,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="meta">@RequestParam(&quot;nonce&quot;)</span> String nonce,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="meta">@RequestParam(&quot;openid&quot;)</span> String openid,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="meta">@RequestParam(name = &quot;encrypt_type&quot;, required = false)</span> String encType,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="meta">@RequestParam(name = &quot;msg_signature&quot;, required = false)</span> String msgSignature)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;\n接收微信请求：[openid=[&#123;&#125;], [signature=[&#123;&#125;], encType=[&#123;&#125;], msgSignature=[&#123;&#125;],&quot;</span></span><br><span class="line">                    + <span class="string">&quot; timestamp=[&#123;&#125;], nonce=[&#123;&#125;], requestBody=[\n&#123;&#125;\n] &quot;</span>,</span><br><span class="line">            openid, signature, encType, msgSignature, timestamp, nonce, requestBody);</span><br><span class="line">    <span class="comment">// 切换appId</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.wxMpService.switchover(appid)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(<span class="string">&quot;未找到对应appid=[%s]的配置，请核实！&quot;</span>, appid));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 验签</span></span><br><span class="line">    <span class="keyword">if</span> (!wxMpService.checkSignature(timestamp, nonce, signature)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;非法请求，可能属于伪造的请求！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String out = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (encType == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 明文传输的消息：解析body</span></span><br><span class="line">        WxMpXmlMessage inMessage = WxMpXmlMessage.fromXml(requestBody);</span><br><span class="line">        <span class="comment">//根据消息进行路由转发</span></span><br><span class="line">        WxMpXmlOutMessage outMessage = <span class="keyword">this</span>.route(inMessage);</span><br><span class="line">        <span class="keyword">if</span> (outMessage == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        out = outMessage.toXml();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;aes&quot;</span>.equalsIgnoreCase(encType)) &#123;</span><br><span class="line">        <span class="comment">// aes加密的消息</span></span><br><span class="line">        WxMpXmlMessage inMessage = WxMpXmlMessage.fromEncryptedXml(requestBody, wxMpService.getWxMpConfigStorage(),</span><br><span class="line">                timestamp, nonce, msgSignature);</span><br><span class="line">        log.debug(<span class="string">&quot;\n消息解密后内容为：\n&#123;&#125; &quot;</span>, inMessage.toString());</span><br><span class="line">        WxMpXmlOutMessage outMessage = <span class="keyword">this</span>.route(inMessage);</span><br><span class="line">        <span class="keyword">if</span> (outMessage == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        out = outMessage.toEncryptedXml(wxMpService.getWxMpConfigStorage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.debug(<span class="string">&quot;\n组装回复信息：&#123;&#125;&quot;</span>, out);</span><br><span class="line">    <span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> WxMpXmlOutMessage <span class="title">route</span><span class="params">(WxMpXmlMessage message)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.messageRouter.route(message);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;路由消息时出现异常！&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启服务，重新关注公众号，可以收到回复消息了吧。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210902173843927.png" alt="image-20210902173843927"></p>
<p><a href="https://gitee.com/ruocy/java_demo/tree/master/boot-wechat">代码地址</a></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://gitee.com/binary/weixin-java-mp-demo-springboot">班纳睿-基于Spring Boot 和 WxJava 实现的微信公众号Java后端Demo，支持多公众号</a></li>
</ul>
]]></content>
      <categories>
        <category>微信公众号开发</category>
      </categories>
      <tags>
        <tag>公众号</tag>
      </tags>
  </entry>
  <entry>
    <title>优秀的博客地址整理</title>
    <url>/2021/05/24/%E4%BC%98%E7%A7%80%E7%9A%84%E5%8D%9A%E5%AE%A2%E5%9C%B0%E5%9D%80/</url>
    <content><![CDATA[<h3 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h3><p>[<a href="https://pdai.tech/">Java 全栈知识体系</a>]</p>
<p>[<a href="https://blog.csdn.net/sudadaipeng1">上面博客的博主CSDN</a>]</p>
<p>[<a href="https://www.fangzhipeng.com/">方志朋的专栏</a>]</p>
<p>[<a href="https://blog.csdn.net/qq_36850813">Java服务端妹子的CSDN</a>]</p>
<h3 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h3><p>[<a href="https://backlog.com/git-tutorial/cn/">猴子都能懂的GIT入门</a>]</p>
<h3 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h3><p>[<a href="https://blog.csdn.net/Eastmount">一个教书的程序员-杨秀璋</a>]</p>
<h3 id="不好归类"><a href="#不好归类" class="headerlink" title="不好归类"></a>不好归类</h3><p>[<a href="https://blog.csdn.net/chushoufengli">比较杂的一个博客CSDN</a>]</p>
<p>[<a href="https://chenyu.blog.csdn.net/article/details/79449026">优秀博客汇总地址</a>]</p>
]]></content>
  </entry>
  <entry>
    <title>hexo（三）使用gitee搭建自己的图床</title>
    <url>/2021/05/11/hexo%EF%BC%88%E4%B8%89%EF%BC%89%E4%BD%BF%E7%94%A8gitee%E6%90%AD%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E5%9B%BE%E5%BA%8A/</url>
    <content><![CDATA[<h2 id="gitee创建个人repo"><a href="#gitee创建个人repo" class="headerlink" title="gitee创建个人repo"></a>gitee创建个人repo</h2><p>使用gitee创建一个public仓库image_repo</p>
<h2 id="下载picGo"><a href="#下载picGo" class="headerlink" title="下载picGo"></a>下载picGo</h2><p>  <a href="https://molunerfinn.com/PicGo/">官网</a> 下载picGo，windows直接选择exe版本。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210511164334718.png" alt="image-20210511164334718"></p>
<p>下载完成，傻瓜安装完成即可。</p>
<span id="more"></span>

<h3 id="创建私人令牌"><a href="#创建私人令牌" class="headerlink" title="创建私人令牌"></a>创建私人令牌</h3><p>头像 –&gt; 设置 –&gt; 私人令牌 –&gt; 生成令牌</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210511164833637.png" alt="image-20210511164833637"></p>
<p>输入密码，生成令牌，复制后面备用。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210511164930817.png" alt="image-20210511164930817"></p>
<p>如果没有复制下来，可以点击修改，重新生成一个。</p>
<h3 id="picGo配置"><a href="#picGo配置" class="headerlink" title="picGo配置"></a>picGo配置</h3><ul>
<li><p>安装gitee插件</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210511165157933.png" alt="image-20210511165157933"></p>
<p>安装后重新打开软件，图床设置，找到gitee菜单。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210511165510260.png" alt="image-20210511165510260"></p>
<p>repo设置右上角圈出的部分。token使用我们上面生成的令牌。然后确定，并设置为默认图床。</p>
</li>
<li><p>使用</p>
<p>接下来就可以使用picGo上传图片了。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210511165940775.png" alt="image-20210511165940775"></p>
<p>上传区上传图片，相册菜单负责管理图片。</p>
</li>
</ul>
<h3 id="Typora配置picGo"><a href="#Typora配置picGo" class="headerlink" title="Typora配置picGo"></a>Typora配置picGo</h3><blockquote>
<p>typoRa是一个极致简洁的markdown编辑器，即时渲染。</p>
</blockquote>
<p>下载链接: <a href="https://www.typora.io/#windows">https://www.typora.io/#windows</a></p>
<p>一路默认安装，打开软件后，文件 –&gt; 偏好设置。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210511170603136.png" alt="image-20210511170603136"></p>
<p>根据图中配置后，可以验证图片上传。出现下图即为配置成功。</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210511170650016.png" alt="image-20210511170650016"></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>到此一个免费的博客图床就配置好了。</p>
]]></content>
      <categories>
        <category>使用hexo搭建博客</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>数学笔记</title>
    <url>/2021/06/17/%E6%95%B0%E5%AD%A6%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h3 id="计划"><a href="#计划" class="headerlink" title="计划"></a>计划</h3><blockquote>
<p>数学一共25道题，3分一个，满分75分。</p>
<p>计划答对20+，得分60+</p>
<p>去年的考题应用题9道，几何7道，数据分析5道，几何2道，其他2道。</p>
</blockquote>
<h3 id="笔记点"><a href="#笔记点" class="headerlink" title="笔记点"></a>笔记点</h3><h4 id="1-数"><a href="#1-数" class="headerlink" title="1. 数"></a>1. 数</h4><h4 id="5-概率与排列组合"><a href="#5-概率与排列组合" class="headerlink" title="5.概率与排列组合"></a>5.概率与排列组合</h4><ol>
<li>加法原理: 分类原理</li>
<li>乘法原理: 分步原理 </li>
</ol>
]]></content>
  </entry>
  <entry>
    <title>英语笔记</title>
    <url>/2021/06/18/%E8%8B%B1%E8%AF%AD%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h3 id="计划"><a href="#计划" class="headerlink" title="计划"></a>计划</h3><blockquote>
<p>英语题型分布：</p>
<p>完形填空，20道题，每题0.5分。满分10分                6</p>
<p>阅读理解，20道题，每题2分。满分40分                  24</p>
<p>新题型，10分                                                            8</p>
<p>翻译题型，英译汉，一共15分                                   10</p>
<p>英语写作，小作文10分，大作文15分。满分25分。 6 + 10</p>
<p>计划得分60分。</p>
</blockquote>
<h3 id="完形填空"><a href="#完形填空" class="headerlink" title="完形填空"></a>完形填空</h3><blockquote>
<p>第一句往往都是题意。</p>
</blockquote>
]]></content>
  </entry>
  <entry>
    <title>SpringCloud学习 | 第六篇 Gateway + Spring Security + OAuth2 + JWT实现微服务统一认证授权</title>
    <url>/2021/05/20/SpringCloud%E5%AD%A6%E4%B9%A0%EF%BC%88%E5%85%AD%EF%BC%89%20OAuth2+JWT%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BB%9F%E4%B8%80%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83/</url>
    <content><![CDATA[<h3 id="OAuth2-与-JWT"><a href="#OAuth2-与-JWT" class="headerlink" title="OAuth2 与 JWT"></a>OAuth2 与 JWT</h3><h4 id="OAuth2"><a href="#OAuth2" class="headerlink" title="OAuth2"></a>OAuth2</h4><p>简单些说就是这套协议包含两个核心角色，认证服务器和资源服务器。</p>
<p>在我们的微服务结构中，网关对应资源服务，auth对应认证服务。</p>
<table>
<thead>
<tr>
<th>模块名</th>
<th>模块作用</th>
<th>OAuth2角色</th>
<th>服务地址</th>
</tr>
</thead>
<tbody><tr>
<td>ruipin-gateway</td>
<td>网关</td>
<td>资源服务器</td>
<td>localhost:9999</td>
</tr>
<tr>
<td>ruipin-auth</td>
<td>认证中心</td>
<td>认证服务器</td>
<td>localhost:8000</td>
</tr>
</tbody></table>
<h4 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h4><p>JWT(JSON Web Token)，一个无状态的token，本身携带用户的信息。</p>
<p>JWT字符串由Header、Payload、Signature三部分组成。</p>
<span id="more"></span>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Header: Json对象，描述JWT的元数据，alg属性表示算法签名，type标识token类型</span><br><span class="line">Payload：Json对象，重要部分，除默认字段，还可以扩展自定义字段，比如用户ID、姓名、角色等。</span><br><span class="line">Signature：对Header、Payload两部分签名，认证服务器私钥签名，然后资源服务器用公钥验签，防止数据篡改。</span><br></pre></td></tr></table></figure>

<p>JWT相比传统Cookie/Session会话管理的重要优势就在于无状态、去中心化，所以JWT更适合分布式场景。</p>
<h4 id="OAuth2与JWT的关系"><a href="#OAuth2与JWT的关系" class="headerlink" title="OAuth2与JWT的关系"></a>OAuth2与JWT的关系</h4><p>OAuth2是认证授权的协议规范。</p>
<p>JWT是基于token的安全认证协议的实现。</p>
<p>OAuth2认证服务器签发的token可以使用JWT实现，JWT轻量且安全。</p>
<h4 id="OAuth2四种授权模式"><a href="#OAuth2四种授权模式" class="headerlink" title="OAuth2四种授权模式"></a>OAuth2四种授权模式</h4><ul>
<li>Authorization Code（授权码模式）：正宗的OAuth2的授权模式，客户端先将用户导向认证服务器，登录后获取授权码，然后进行授权，最后根据授权码获取访问令牌</li>
<li>Implicit（简化模式）：和授权码模式相比，取消了获取授权码的过程，直接获取访问令牌；</li>
<li>Resource Owner Password Credentials（密码模式）：客户端直接向用户获取用户名和密码，之后向认证服务器获取访问令牌；</li>
<li>Client Credentials（客户端模式）：客户端直接通过客户端认证（比如client_id和client_secret）从认证服务器获取访问令牌。</li>
</ul>
<p>此处我们主要选择密码模式</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210520104647787.png" alt="image-20210520104647787"></p>
<ul>
<li>客户端从用户获取用户名和密码。</li>
<li>客户端通过用户名和密码访问认证服务器。</li>
<li>认证服务器返回访问令牌。</li>
</ul>
<h3 id="SpringCloud整合OAuth2和JWT"><a href="#SpringCloud整合OAuth2和JWT" class="headerlink" title="SpringCloud整合OAuth2和JWT"></a>SpringCloud整合OAuth2和JWT</h3><p>涉及到的服务主要有：</p>
<table>
<thead>
<tr>
<th>模块</th>
<th>端口</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Nacos servr</td>
<td>8848</td>
<td>注册中心</td>
</tr>
<tr>
<td>ruipin-sys</td>
<td>8060</td>
<td>服务提供方</td>
</tr>
<tr>
<td>ruipin-sys-api</td>
<td>–</td>
<td>服务API</td>
</tr>
<tr>
<td>ruipin-auth</td>
<td>8000</td>
<td>认证服务器</td>
</tr>
<tr>
<td>ruipin-gateway</td>
<td>9999</td>
<td>网关服务器+资源服务器</td>
</tr>
</tbody></table>
<p>这里大致梳理下认证的一个简单流程：</p>
<ul>
<li>前端请求 <a href="http://ip:9999/auth/oauth/token%E6%9C%8D%E5%8A%A1%E8%8E%B7%E5%8F%96token%E3%80%82">http://ip:9999/auth/oauth/token服务获取token。</a><ul>
<li>请求auth，auth先判断client是否有效，再调用用户模块验证用户是否存在，</li>
<li>存在，则将用户信息（基本信息+角色权限信息）写入token</li>
</ul>
</li>
<li>前端携带token访问<a href="http://ip:9999/sys/serviceA/%E6%9C%8D%E5%8A%A1%E8%AE%BF%E9%97%AE%E5%85%B7%E4%BD%93%E6%9C%8D%E5%8A%A1%E3%80%82">http://ip:9999/sys/serviceA/服务访问具体服务。</a></li>
<li>网关根据token 解析，判断用户是否有权限访问接口。如有，则转发请求到sys服务，如无则返回无权限。</li>
</ul>
<h4 id="ruipin-sys"><a href="#ruipin-sys" class="headerlink" title="ruipin-sys"></a>ruipin-sys</h4><p>目前主要提供3个功能：</p>
<ol>
<li>提供获取用户信息接口，用于获取token时的鉴权。</li>
<li>提供获取用户信息接口，用于后面用户携带token的鉴权测试。（此处我是偷懒用了同一个接口）</li>
<li>提供初始化角色权限job，项目启动时redis缓存 各接口所需角色信息，便于2的鉴权。</li>
</ol>
<h5 id="pom依赖"><a href="#pom依赖" class="headerlink" title="pom依赖"></a>pom依赖</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- SpringCloud从2020版本后对配置文件加载进行了重构，</span></span><br><span class="line"><span class="comment">        默认不加载bootstrap配置文件，添加bootstrap依赖解决该问题 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 注册中心 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 配置中心 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ruipin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ruipin-sys-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;ruipin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ruipin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>common-mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;ruipin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ruipin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>common-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;ruipin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h5><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8060</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ruipin-sys</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://49.4.78.75:3306/ruipin_test?useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">ruipintest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">pass@word1</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">http://localhost:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">$&#123;spring.cloud.nacos.discovery.server-addr&#125;</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapping/*.xml</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="comment"># 驼峰下划线转换</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 这个配置会将执行的sql打印出来，在开发或测试的时候可以用</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br></pre></td></tr></table></figure>

<p>这里可以使用Mybatis-Plus Generator插件，对应数据库生成mybatis相关代码。我们这里暂时都是写死的逻辑，所以可以不需要。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 因为我们写死逻辑，所以配置目前不必需</span><br><span class="line">@Configuration</span><br><span class="line">@MapperScan(&quot;com.ruipin.sys.mapper&quot;)</span><br><span class="line">public class MybatisConfig &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>提供一个获取用户信息的接口：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/userAccount&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserAccountController</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 接口直接构建了一个用户对象，密码根据目前的配置使用的BCypt加密的123456</span></span><br><span class="line"><span class="comment">	 * 该用户拥有ADMIN角色</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/username/&#123;username&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">getUserAccountByUsername</span><span class="params">(<span class="meta">@PathVariable</span> String username)</span></span>&#123;</span><br><span class="line">        AccountDto account = <span class="keyword">new</span> AccountDto();</span><br><span class="line">        account.setId(<span class="number">1l</span>);</span><br><span class="line">        account.setUsername(username);</span><br><span class="line">        account.setPassword(<span class="string">&quot;$2a$10$cnaQ7AbWqzEs9EFg59xO5eLqJcs4..BY7mCI8pEQ6Cu.iF2YHPV.m&quot;</span>);</span><br><span class="line">        account.setRoles(Arrays.asList(<span class="string">&quot;ADMIN&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> Result.success(account);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>建一个Job，在项目启动时加载缓存信息：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Component</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">@Slf4j</span><br><span class="line">public class InitPermissionJob implements CommandLineRunner &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run(String... args) throws Exception &#123;</span><br><span class="line">        refreshFrontMenuCache();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public boolean refreshFrontMenuCache() &#123;</span><br><span class="line">    	// 此处也是写死的逻辑，稍后调试通以后可以接入Mybatis数据库</span><br><span class="line">        redisTemplate.delete(RedisKeys.RESOURCE_ROLES_MAP);</span><br><span class="line">        Map&lt;String, List&lt;String&gt;&gt; map = new TreeMap&lt;&gt;();</span><br><span class="line">        map.put(&quot;/sys/**&quot;, CollUtil.toList(&quot;ROLE_ADMIN&quot;)); // ROLE_是jwt</span><br><span class="line">        redisTemplate.opsForHash().putAll(RedisKeys.RESOURCE_ROLES_MAP, map);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>建立启动类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">public class SysApplication &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(SysApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ruipin-sys-api"><a href="#ruipin-sys-api" class="headerlink" title="ruipin-sys-api"></a>ruipin-sys-api</h4><h5 id="pom依赖-1"><a href="#pom依赖-1" class="headerlink" title="pom依赖"></a>pom依赖</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 远程调用HTTP客户端 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- openfeign依赖 1. http客户端选择okhttp 2. loadbalancer替换ribbon --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="feign接口"><a href="#feign接口" class="headerlink" title="feign接口"></a>feign接口</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@FeignClient(name=&quot;ruipin-sys&quot;, contextId = &quot;account&quot;)</span><br><span class="line">public interface AccountFeignClient &#123;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;/userAccount/username/&#123;username&#125;&quot;)</span><br><span class="line">    Result&lt;AccountDto&gt; getUserAccountByUsername(@PathVariable String username);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Data</span><br><span class="line">@NoArgsConstructor</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">public class AccountDto &#123;</span><br><span class="line"></span><br><span class="line">    private Long id;</span><br><span class="line">    private String username;</span><br><span class="line">    private String password;</span><br><span class="line">    private List&lt;String&gt; roles;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ruipin-auth"><a href="#ruipin-auth" class="headerlink" title="ruipin-auth"></a>ruipin-auth</h4><p>auth主要有以下几个：</p>
<p>​    JwtTokenEnhancer： JWT增强配置</p>
<p>   AuthorizationServerConfig 认证核心配置</p>
<p>   WebSecurityConfig  访问核心配置</p>
<p>   AuthController 提供获取token接口</p>
<p>   PublicKeyController 提供公钥获取接口</p>
<p>   SecurityUser 提供token鉴权的用户信息</p>
<p>   UserDetailServiceImpl 前期用户查询</p>
<h5 id="pom依赖-2"><a href="#pom依赖-2" class="headerlink" title="pom依赖"></a>pom依赖</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;!-- SpringCloud从2020版本后对配置文件加载进行了重构，</span><br><span class="line">    默认不加载bootstrap配置文件，添加bootstrap依赖解决该问题 --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-cloud-starter-bootstrap&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-cloud-starter-loadbalancer&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;!-- 注册中心 --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- nacos-config 配置中心依赖--&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- OAuth2 认证服务器--&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.security.oauth.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-security-oauth2-autoconfigure&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-security-oauth2-jose&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.ruipin&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;common-core&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;ruipin.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.ruipin&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;ruipin-demo-api&lt;/artifactId&gt;</span><br><span class="line">   		&lt;version&gt;$&#123;ruipin.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.ruipin&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;ruipin-sys-api&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;ruipin.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.ruipin&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;common-mybatis&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;ruipin.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<h5 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h5><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ruipin-auth</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3307/ruipin_2021?zeroDateTimeBehavior=convertToNull&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai&amp;autoReconnect=true</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">http://127.0.0.1:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span>      <span class="comment"># 默认值 properties</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span>      <span class="comment"># 默认值 DEFAULT_GROUP</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line"><span class="attr">example:</span></span><br><span class="line">  <span class="attr">hello-word:</span> <span class="string">Hello</span> <span class="string">Ruipin</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">okhttp:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h5 id="AuthorizationServerConfig"><a href="#AuthorizationServerConfig" class="headerlink" title="AuthorizationServerConfig"></a>AuthorizationServerConfig</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthorizationServerConfig</span> <span class="keyword">extends</span> <span class="title">AuthorizationServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserDetailServiceImpl userDetailsService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationManager authenticationManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtTokenEnhancer jwtTokenEnhancer;</span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        clients.inMemory()</span><br><span class="line">            .withClient(<span class="string">&quot;client-app&quot;</span>)<span class="comment">//配置client_id</span></span><br><span class="line">            .secret(passwordEncoder.encode(<span class="string">&quot;123456&quot;</span>))<span class="comment">//配置client_secret</span></span><br><span class="line">            .scopes(<span class="string">&quot;all&quot;</span>)<span class="comment">//配置申请的权限范围</span></span><br><span class="line">            .authorizedGrantTypes(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;refresh_token&quot;</span>)</span><br><span class="line">            <span class="comment">//配置grant_type，表示授权类型</span></span><br><span class="line">            .accessTokenValiditySeconds(<span class="number">3600</span>)<span class="comment">//配置访问token的有效期</span></span><br><span class="line">            .refreshTokenValiditySeconds(<span class="number">86400</span>);<span class="comment">//配置刷新token的有效期</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码模式需要配置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> endpoints</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        TokenEnhancerChain enhancerChain = <span class="keyword">new</span> TokenEnhancerChain();</span><br><span class="line">        List&lt;TokenEnhancer&gt; delegates = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        delegates.add(jwtTokenEnhancer);</span><br><span class="line">        delegates.add(accessTokenConverter());</span><br><span class="line">        enhancerChain.setTokenEnhancers(delegates); <span class="comment">//配置JWT的内容增强器</span></span><br><span class="line">        endpoints.authenticationManager(authenticationManager)</span><br><span class="line">                .userDetailsService(userDetailsService) <span class="comment">//配置加载用户信息的服务</span></span><br><span class="line">                .accessTokenConverter(accessTokenConverter())</span><br><span class="line">                .tokenEnhancer(enhancerChain);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        security.allowFormAuthenticationForClients();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JwtAccessTokenConverter <span class="title">accessTokenConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JwtAccessTokenConverter jwtAccessTokenConverter = <span class="keyword">new</span> JwtAccessTokenConverter();</span><br><span class="line">        jwtAccessTokenConverter.setKeyPair(keyPair());</span><br><span class="line">        <span class="keyword">return</span> jwtAccessTokenConverter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KeyPair <span class="title">keyPair</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        KeyStoreKeyFactory factory = <span class="keyword">new</span> KeyStoreKeyFactory(<span class="keyword">new</span> 	          ClassPathResource(<span class="string">&quot;ruipin.jks&quot;</span>), <span class="string">&quot;123456&quot;</span>.toCharArray());</span><br><span class="line">        <span class="keyword">return</span> factory.getKeyPair(<span class="string">&quot;ruipin&quot;</span>, <span class="string">&quot;rui_pin2021&quot;</span>.toCharArray());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="WebSecurityConfig"><a href="#WebSecurityConfig" class="headerlink" title="WebSecurityConfig"></a>WebSecurityConfig</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .requestMatchers(EndpointRequest.toAnyEndpoint()).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/rsa/publicKey&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationManager <span class="title">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="AuthController与PublicKeyController"><a href="#AuthController与PublicKeyController" class="headerlink" title="AuthController与PublicKeyController"></a>AuthController与PublicKeyController</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/oauth&quot;)</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TokenEndpoint tokenEndpoint;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/token&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OAuth2AccessToken <span class="title">postAccessToken</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            Principal principal,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@RequestParam</span> Map&lt;String, String&gt; parameters</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span> <span class="keyword">throws</span> HttpRequestMethodNotSupportedException </span>&#123;</span><br><span class="line">        OAuth2AccessToken oAuth2AccessToken;</span><br><span class="line"></span><br><span class="line">        oAuth2AccessToken = tokenEndpoint.postAccessToken(principal, parameters).getBody();</span><br><span class="line">        <span class="keyword">return</span> oAuth2AccessToken;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PublicKeyController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KeyPair keyPair;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/rsa/publicKey&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">loadPublicKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RSAPublicKey publicKey = (RSAPublicKey) keyPair.getPublic();</span><br><span class="line">        RSAKey key = <span class="keyword">new</span> RSAKey.Builder(publicKey).build();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JWKSet(key).toJSONObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="SecurityUser"><a href="#SecurityUser" class="headerlink" title="SecurityUser"></a>SecurityUser</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityUser</span> <span class="keyword">implements</span> <span class="title">UserDetails</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String clientId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Collection&lt;SimpleGrantedAuthority&gt; authorities;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SecurityUser</span><span class="params">(AccountDto account)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setId(account.getId());</span><br><span class="line">        <span class="keyword">this</span>.setUsername(account.getUsername());</span><br><span class="line"><span class="comment">//        this.setPassword(AuthConstants.BCRYPT + account.getPassword());</span></span><br><span class="line">        <span class="keyword">this</span>.setPassword(account.getPassword());</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtil.isNotEmpty(account.getRoles())) &#123;</span><br><span class="line">            authorities = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            account.getRoles().forEach(roleId -&gt; authorities.add(<span class="keyword">new</span> SimpleGrantedAuthority(String.valueOf(roleId))));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCredentialsNonExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="UserDetailServiceImpl"><a href="#UserDetailServiceImpl" class="headerlink" title="UserDetailServiceImpl"></a>UserDetailServiceImpl</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDetailServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountFeignClient accountFeignClient;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line">    <span class="keyword">private</span> List&lt;AccountDto&gt; userList;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException</span>&#123;</span><br><span class="line">        AccountDto accountDto = <span class="keyword">new</span> AccountDto();</span><br><span class="line">        Result result = accountFeignClient.getUserAccountByUsername(username);</span><br><span class="line">        log.info(<span class="string">&quot;获取用户信息:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        <span class="keyword">if</span> (ResultCode.SUCCESS.getCode().equals(result.getCode())) &#123;</span><br><span class="line">            accountDto = (AccountDto) result.getData();</span><br><span class="line">            securityUser = <span class="keyword">new</span> SecurityUser(accountDto);</span><br><span class="line">        &#125;</span><br><span class="line">        securityUser = <span class="keyword">new</span> SecurityUser(accountDto);</span><br><span class="line">        <span class="keyword">return</span> securityUser;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="JWT增强"><a href="#JWT增强" class="headerlink" title="JWT增强"></a>JWT增强</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/**</span><br><span class="line"> * JWT内容增强器</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">public class JwtTokenEnhancer implements TokenEnhancer &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public OAuth2AccessToken enhance(OAuth2AccessToken accessToken, OAuth2Authentication authentication) &#123;</span><br><span class="line">        SecurityUser securityUser = (SecurityUser) authentication.getPrincipal();</span><br><span class="line">        Map&lt;String, Object&gt; info = new HashMap&lt;&gt;();</span><br><span class="line">        //把用户ID设置到JWT中</span><br><span class="line">        info.put(&quot;id&quot;, securityUser.getId());</span><br><span class="line">        ((DefaultOAuth2AccessToken) accessToken).setAdditionalInformation(info);</span><br><span class="line">        return accessToken;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="启动类"><a href="#启动类" class="headerlink" title="启动类"></a>启动类</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(AuthApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ruipin-gateway"><a href="#ruipin-gateway" class="headerlink" title="ruipin-gateway"></a>ruipin-gateway</h4><h5 id="pom依赖-3"><a href="#pom依赖-3" class="headerlink" title="pom依赖"></a>pom依赖</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;!-- SpringCloud从2020版本后对配置文件加载进行了重构，</span><br><span class="line">    默认不加载bootstrap配置文件，添加bootstrap依赖解决该问题 --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-cloud-starter-bootstrap&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;!-- 2020Cloud版本，不加该依赖可能在路由转发时会报503 --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-cloud-starter-loadbalancer&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 注册中心 --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- oauth2 资源服务器--&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-security-config&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-security-oauth2-resource-server&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-security-oauth2-jose&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.ruipin&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;common-core&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.ruipin&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;common-redis&lt;/artifactId&gt;</span><br><span class="line">    	&lt;version&gt;1.0&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<h5 id="配置文件-2"><a href="#配置文件-2" class="headerlink" title="配置文件"></a>配置文件</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 9999</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: ruipin-gateway</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      # 注册中心</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: http://127.0.0.1:8848</span><br><span class="line">      # 配置中心</span><br><span class="line">      config:</span><br><span class="line">        server-addr: $&#123;spring.cloud.nacos.discovery.server-addr&#125;</span><br><span class="line">        file-extension: yaml</span><br><span class="line">    gateway:</span><br><span class="line">      discovery:</span><br><span class="line">        locator:</span><br><span class="line">          enabled: true  # 启用动根据服务id生成路由</span><br><span class="line">          lower-case-service-id: true # 设置路由的路径为小写的服务ID</span><br><span class="line">      routes:</span><br><span class="line">        - id: auth-route</span><br><span class="line">          uri: lb://ruipin-auth</span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/auth/**  # 根据路径进行匹配，所有/auth/**开头的请求都会转发到 lb://ruipin-auth</span><br><span class="line">          filters:</span><br><span class="line">            - StripPrefix=1 # 移除前缀 /auth</span><br><span class="line">        - id: sys-route</span><br><span class="line">          uri: lb://ruipin-sys</span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/sys/**</span><br><span class="line">          filters:</span><br><span class="line">            - StripPrefix=1 # 移除前缀 /sys</span><br><span class="line">  security:</span><br><span class="line">    oauth2:</span><br><span class="line">      resourceserver:</span><br><span class="line">        jwt:</span><br><span class="line">          jwk-set-uri: &#x27;http://localhost:8000/rsa/publicKey&#x27;</span><br><span class="line">white-list:</span><br><span class="line">  urls:</span><br><span class="line">    - &quot;/auth/oauth/token&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="ResourceServerConfig"><a href="#ResourceServerConfig" class="headerlink" title="ResourceServerConfig"></a>ResourceServerConfig</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.ruipin.gateway.config;</span><br><span class="line"></span><br><span class="line">import cn.hutool.core.util.ArrayUtil;</span><br><span class="line">import com.ruipin.common.constant.AuthConstants;</span><br><span class="line">import com.ruipin.common.result.ResultCode;</span><br><span class="line">import com.ruipin.gateway.security.AuthorizationManager;</span><br><span class="line">import com.ruipin.gateway.util.WebUtils;</span><br><span class="line">import lombok.AllArgsConstructor;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.core.convert.converter.Converter;</span><br><span class="line">import org.springframework.security.authentication.AbstractAuthenticationToken;</span><br><span class="line">import org.springframework.security.config.annotation.web.reactive.EnableWebFluxSecurity;</span><br><span class="line">import org.springframework.security.config.web.server.ServerHttpSecurity;</span><br><span class="line">import org.springframework.security.oauth2.jwt.Jwt;</span><br><span class="line">import org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationConverter;</span><br><span class="line">import org.springframework.security.oauth2.server.resource.authentication.JwtGrantedAuthoritiesConverter;</span><br><span class="line">import org.springframework.security.oauth2.server.resource.authentication.ReactiveJwtAuthenticationConverterAdapter;</span><br><span class="line">import org.springframework.security.web.server.SecurityWebFilterChain;</span><br><span class="line">import org.springframework.security.web.server.ServerAuthenticationEntryPoint;</span><br><span class="line">import org.springframework.security.web.server.authorization.ServerAccessDeniedHandler;</span><br><span class="line">import reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 资源服务器配置</span><br><span class="line"> */</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">@Configuration</span><br><span class="line">@EnableWebFluxSecurity</span><br><span class="line">public class ResourceServerConfig &#123;</span><br><span class="line"></span><br><span class="line">    private AuthorizationManager authorizationManager;</span><br><span class="line">    private WhiteListConfig whiteListConfig;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public SecurityWebFilterChain securityWebFilterChain(ServerHttpSecurity http) &#123;</span><br><span class="line">        http.oauth2ResourceServer().jwt()</span><br><span class="line">                .jwtAuthenticationConverter(jwtAuthenticationConverter());</span><br><span class="line">        //自定义处理JWT请求头过期或签名错误的结果</span><br><span class="line">        http.oauth2ResourceServer().authenticationEntryPoint(authenticationEntryPoint());</span><br><span class="line">        //处理白名单请求</span><br><span class="line">        http.authorizeExchange()</span><br><span class="line">                .pathMatchers(ArrayUtil.toArray(whiteListConfig.getUrls(), String.class)).permitAll()</span><br><span class="line">                .anyExchange().access(authorizationManager)//鉴权管理器配置</span><br><span class="line">                .and()</span><br><span class="line">                .exceptionHandling()</span><br><span class="line">                .accessDeniedHandler(accessDeniedHandler()) // 处理未授权</span><br><span class="line">                .authenticationEntryPoint(authenticationEntryPoint()) //处理未认证</span><br><span class="line">                .and().csrf().disable();</span><br><span class="line">        return http.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 未授权</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    ServerAccessDeniedHandler accessDeniedHandler() &#123;</span><br><span class="line">        return (exchange, denied) -&gt; &#123;</span><br><span class="line">            Mono&lt;Void&gt; mono = Mono.defer(() -&gt; Mono.just(exchange.getResponse()))</span><br><span class="line">                    .flatMap(response -&gt; WebUtils.writeFailedToResponse(response, ResultCode.ACCESS_UNAUTHORIZED));</span><br><span class="line">            return mono;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * token无效或者已过期自定义响应</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    ServerAuthenticationEntryPoint authenticationEntryPoint() &#123;</span><br><span class="line">        return (exchange, e) -&gt; &#123;</span><br><span class="line">            Mono&lt;Void&gt; mono = Mono.defer(() -&gt; Mono.just(exchange.getResponse()))</span><br><span class="line">                    .flatMap(response -&gt; WebUtils.writeFailedToResponse(response,ResultCode.TOKEN_INVALID_OR_EXPIRED));</span><br><span class="line">            return mono;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @return</span><br><span class="line">     * @link https://blog.csdn.net/qq_24230139/article/details/105091273</span><br><span class="line">     * ServerHttpSecurity没有将jwt中authorities的负载部分当做Authentication</span><br><span class="line">     * 需要把jwt的Claim中的authorities加入</span><br><span class="line">     * 方案：重新定义R 权限管理器，默认转换器JwtGrantedAuthoritiesConverter</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public Converter&lt;Jwt, ? extends Mono&lt;? extends AbstractAuthenticationToken&gt;&gt; jwtAuthenticationConverter() &#123;</span><br><span class="line">        JwtGrantedAuthoritiesConverter jwtGrantedAuthoritiesConverter = new JwtGrantedAuthoritiesConverter();</span><br><span class="line">        jwtGrantedAuthoritiesConverter.setAuthorityPrefix(AuthConstants.AUTHORITY_PREFIX);</span><br><span class="line">        jwtGrantedAuthoritiesConverter.setAuthoritiesClaimName(AuthConstants.JWT_AUTHORITIES_KEY);</span><br><span class="line"></span><br><span class="line">        JwtAuthenticationConverter jwtAuthenticationConverter = new JwtAuthenticationConverter();</span><br><span class="line">        jwtAuthenticationConverter.setJwtGrantedAuthoritiesConverter(jwtGrantedAuthoritiesConverter);</span><br><span class="line">        return new ReactiveJwtAuthenticationConverterAdapter(jwtAuthenticationConverter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="WhiteListConfig"><a href="#WhiteListConfig" class="headerlink" title="WhiteListConfig"></a>WhiteListConfig</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Data</span><br><span class="line">@Configuration</span><br><span class="line">@ConfigurationProperties(prefix = &quot;whitelist&quot;)</span><br><span class="line">public class WhiteListConfig &#123;</span><br><span class="line"></span><br><span class="line">    private List&lt;String&gt; urls;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="AuthorizationManager"><a href="#AuthorizationManager" class="headerlink" title="AuthorizationManager"></a>AuthorizationManager</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Component</span><br><span class="line">@Slf4j</span><br><span class="line">public class AuthorizationManager implements ReactiveAuthorizationManager&lt;AuthorizationContext&gt; &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Mono&lt;AuthorizationDecision&gt; check(Mono&lt;Authentication&gt; mono, AuthorizationContext authorizationContext) &#123;</span><br><span class="line"></span><br><span class="line">        ServerHttpRequest request = authorizationContext.getExchange().getRequest();</span><br><span class="line">        String restPath = request.getMethodValue() + &quot;_&quot; + request.getURI().getPath();</span><br><span class="line">        log.info(&quot;请求路径：&#123;&#125;&quot;, restPath);</span><br><span class="line">        PathMatcher pathMatcher = new AntPathMatcher();</span><br><span class="line">        // 对应跨域的预检请求直接放行</span><br><span class="line">        if (request.getMethod() == HttpMethod.OPTIONS) &#123;</span><br><span class="line">            return Mono.just(new AuthorizationDecision(true));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">//        // 非管理端路径无需鉴权直接放行</span><br><span class="line">//        if (!pathMatcher.match(AuthConstants.ADMIN_URL_PATTERN, restPath)) &#123;</span><br><span class="line">//            log.info(&quot;请求无需鉴权，请求路径：&#123;&#125;&quot;, restPath);</span><br><span class="line">//            return Mono.just(new AuthorizationDecision(true));</span><br><span class="line">//        &#125;</span><br><span class="line"></span><br><span class="line">        // 从缓存取资源权限角色关系列表</span><br><span class="line">        Map&lt;Object, Object&gt; permissionRoles = redisTemplate.opsForHash().entries(RedisKeys.RESOURCE_ROLES_MAP);</span><br><span class="line">        Iterator&lt;Object&gt; iterator = permissionRoles.keySet().iterator();</span><br><span class="line">        // 请求路径匹配到的资源需要的角色权限集合authorities统计</span><br><span class="line">        Set&lt;String&gt; authorities = new HashSet&lt;&gt;();</span><br><span class="line">        while (iterator.hasNext()) &#123;</span><br><span class="line">            String pattern = (String) iterator.next();</span><br><span class="line">            if (pathMatcher.match(pattern, request.getURI().getPath())) &#123;</span><br><span class="line">                authorities.addAll(Convert.toList(String.class, permissionRoles.get(pattern)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Mono&lt;AuthorizationDecision&gt; authorizationDecisionMono = mono</span><br><span class="line">                .filter(Authentication::isAuthenticated)</span><br><span class="line">                .flatMapIterable(Authentication::getAuthorities)</span><br><span class="line">                .map(GrantedAuthority::getAuthority)</span><br><span class="line">                .any(roleId -&gt; &#123;</span><br><span class="line">                    // roleId是请求用户的角色(格式:ROLE_&#123;roleId&#125;)，authorities是请求资源所需要角色的集合</span><br><span class="line">                    log.info(&quot;访问路径：&#123;&#125;&quot;, request.getURI().getPath());</span><br><span class="line">                    log.info(&quot;用户角色：&#123;&#125;&quot;, roleId);</span><br><span class="line">                    log.info(&quot;资源需要角色：&#123;&#125;&quot;, authorities);</span><br><span class="line">                    return authorities.contains(roleId);</span><br><span class="line">                &#125;)</span><br><span class="line">                .map(AuthorizationDecision::new)</span><br><span class="line">                .defaultIfEmpty(new AuthorizationDecision(false));</span><br><span class="line">        return authorizationDecisionMono;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="WebUtils"><a href="#WebUtils" class="headerlink" title="WebUtils"></a>WebUtils</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">public class WebUtils &#123;</span><br><span class="line"></span><br><span class="line">    public static Mono writeFailedToResponse(ServerHttpResponse response, ResultCode resultCode)&#123;</span><br><span class="line">        response.setStatusCode(HttpStatus.OK);</span><br><span class="line">        response.getHeaders().set(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE);</span><br><span class="line">        response.getHeaders().set(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);</span><br><span class="line">        response.getHeaders().set(&quot;Cache-Control&quot;, &quot;no-cache&quot;);</span><br><span class="line">        String body = JSONUtil.toJsonStr(Result.failed(resultCode));</span><br><span class="line">        DataBuffer buffer = response.bufferFactory().wrap(body.getBytes(Charset.forName(&quot;UTF-8&quot;)));</span><br><span class="line">        return response.writeWith(Mono.just(buffer))</span><br><span class="line">                .doOnError(error -&gt; DataBufferUtils.release(buffer));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="启动类-1"><a href="#启动类-1" class="headerlink" title="启动类"></a>启动类</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">@SpringBootApplication</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">public class GatewayApplication &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(GatewayApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>启动nacos、sys、auth和gateway服务。</p>
<p>检查redis</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210520115808394.png" alt="image-20210520115808394"></p>
<p>不携带token访问接口ip:9999/sys/userAccount/username/jack,提示token无效或过期</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210520115909741.png" alt="image-20210520115909741"></p>
<p>获取token</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210520115957591.png" alt="image-20210520115957591"></p>
<p>拿access_token再次访问接口ip:9999/sys/userAccount/username/jack</p>
<p><img src="https://gitee.com/ruocy/image_repo/raw/master/images/image-20210520120058738.png" alt="image-20210520120058738"></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>到此，SpringCloud整合OAuth和JWT就完毕了。其中里面有很多理论性的东西，我也不是很明白，只能等后续弄清楚再继续了。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p>[<a href="http://www.macrozheng.com/#/cloud/oauth2?id=spring-cloud-security%EF%BC%9Aoauth2%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8">Spring Cloud Security：Oauth2使用入门</a>]</p>
<p>[<a href="https://www.cnblogs.com/haoxianrui/p/13719356.html">Spring Cloud实战 | 第六篇：Spring Cloud Gateway + Spring Security OAuth2 + JWT实现微服务统一认证鉴权</a>]</p>
]]></content>
      <categories>
        <category>SpringCloud从零开始构建微服务</category>
      </categories>
      <tags>
        <tag>SpringCloud</tag>
      </tags>
  </entry>
</search>
